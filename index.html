<!DOCTYPE html>
<html>
<head>
    <title>The Commons Feed</title>
    <style>
        .feed-container { max-width: 800px; margin: 0 auto; padding: 20px; font-family: Arial, sans-serif; }
        .feed-item { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .feed-item img { max-width: 100%; height: auto; border-radius: 4px; margin-top: 10px; }
        .feed-author { font-weight: bold; color: #2c4f90; }
        .feed-timestamp { color: #666; font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="feed-container" id="feed"></div>
    <script>
        const featureLayerUrl = "https://services7.arcgis.com/glzyAmcOgJqIUWmg/arcgis/rest/services/service_f2459b3aa83c4162a52c6370048b72ea/FeatureServer/0";

        // Fetch first photo from related tables (indices 1-4)
        async function getFirstPhotoUrl(objectId) {
            const relatedTables = [1, 2, 3, 4];
            for (const tableId of relatedTables) {
                try {
                    const url = `${featureLayerUrl}/../${tableId}`;
                    const response = await fetch(`${url}/query?where=ParentObjectID=${objectId}&f=json`);
                    const data = await response.json();
                    if (data.features?.length > 0 && data.features[0].attributes.URL) {
                        return data.features[0].attributes.URL;
                    }
                } catch (error) {
                    console.error(`Error fetching from table ${tableId}:`, error);
                }
            }
            return null;
        }

        async function loadFeed() {
            try {
                // Fields from your schema (adjust as needed)
                const response = await fetch(`${featureLayerUrl}/query?where=1=1&outFields=name,address,city,zip,county,contact_name,phone,email,CreationDate&orderByFields=CreationDate DESC&f=json`);
                const data = await response.json();
                const feed = document.getElementById("feed");
                feed.innerHTML = "";

                for (const feature of data.features) {
                    const a = feature.attributes;
                    const feedItem = document.createElement("div");
                    feedItem.className = "feed-item";
                    const imageUrl = await getFirstPhotoUrl(a.objectid);

                    feedItem.innerHTML = `
                        <div class="feed-author">${a.name || "Anonymous"}</div>
                        <div class="feed-timestamp">${a.CreationDate ? new Date(a.CreationDate).toLocaleString() : ""}</div>
                        ${a.address ? `<div><strong>Address:</strong> ${a.address}, ${a.city || ""} ${a.zip || ""} ${a.county || ""}</div>` : ""}
                        ${a.contact_name ? `<div><strong>Contact:</strong> ${a.contact_name} ${a.phone ? "| " + a.phone : ""} ${a.email ? "| " + a.email : ""}</div>` : ""}
                        ${imageUrl ? `<img src="${imageUrl}" alt="Submission photo">` : ""}
                    `;
                    feed.appendChild(feedItem);
                }
            } catch (error) {
                document.getElementById("feed").innerHTML = "⚠️ Failed to load data. Check the console.";
            }
        }

        loadFeed();
    </script>
</body>
</html>
