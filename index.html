<!DOCTYPE html>
<html>
<head>
    <title>The Commons Community Feed</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://js.arcgis.com/4.28/"></script>
    <style>
        /* Previous CSS remains unchanged */
    </style>
</head>
<body>
    <div class="feed-container" id="feed">
        <div class="loader"></div>
    </div>

    <div class="lightbox" id="lightbox">
        <img class="lightbox-img" id="lightboxImage">
    </div>

    <script>
        require(["esri/request"], (esriRequest) => {
            const MAIN_LAYER_URL = "https://services7.arcgis.com/glzyAmcOgJqIUWmg/arcgis/rest/services/service_f2459b3aa83c4162a52c6370048b72ea/FeatureServer/0";
            const PHOTO_TABLES = [1, 2, 3, 4];
            const CATEGORY_ICONS = {
                yard_sale: 'ğŸ·ï¸', classified: 'ğŸ“¦', business: 'ğŸ¢',
                csa: 'ğŸ§º', farmers_market: 'ğŸ¥•', community_garden: 'ğŸŒ±',
                food_pantry: 'ğŸ¥«', farm_stand: 'ğŸšœ', restaurant: 'ğŸ½ï¸',
                educational_program: 'ğŸ“', artisinal: 'ğŸ§€', barter_swap: 'ğŸ¤',
                preservation: 'ğŸ«™', community_kitchen: 'ğŸ²', default: 'âœ¨'
            };

            async function loadFeed() {
                try {
                    const feed = document.getElementById("feed");
                    feed.innerHTML = '<div class="loader"></div>';
                    
                    const { data: mainData } = await esriRequest(`${MAIN_LAYER_URL}/query`, {
                        query: {
                            where: "1=1",
                            outFields: "*",
                            orderByFields: "CreationDate DESC",
                            f: "json"
                        }
                    });

                    feed.innerHTML = '';
                    
                    for (const feature of mainData.features) {
                        const attrs = feature.attributes;
                        const photos = await getPhotosForFeature(feature);
                        
                        const card = document.createElement('div');
                        card.className = 'feed-item';
                        card.innerHTML = `
                            <!-- Card content unchanged from previous version -->
                        `;
                        
                        feed.appendChild(card);
                    }

                    // Enhanced auto-loop logic
                    let isScrolling;
                    window.addEventListener('scroll', () => {
                        window.clearTimeout(isScrolling);
                        isScrolling = setTimeout(() => {
                            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 200) {
                                window.scrollTo({ top: 0, behavior: "smooth" });
                                setTimeout(loadFeed, 1000);
                            }
                        }, 100);
                    });

                } catch(error) {
                    console.error("Feed Error:", error);
                    feed.innerHTML = '<div class="feed-item">âŒ Error loading feed</div>';
                }
            }

            async function getPhotosForFeature(feature) {
                const photos = [];
                const globalId = feature.attributes.globalid;
                
                for (const tableId of PHOTO_TABLES) {
                    const tableUrl = MAIN_LAYER_URL.replace("/0", `/${tableId}`);
                    try {
                        const { data: relatedData } = await esriRequest(`${tableUrl}/query`, {
                            query: { 
                                where: `ParentGlobalID='${globalId}'`,
                                outFields: "objectid",  // Corrected case sensitivity
                                f: "json" 
                            }
                        });
                        
                        for (const rel of relatedData.features || []) {
                            const { data: attachments } = await esriRequest(
                                `${tableUrl}/${rel.attributes.objectid}/attachments?f=json`
                            );
                            if (attachments?.attachmentInfos?.length) {
                                photos.push(...attachments.attachmentInfos.map(a => 
                                    `${tableUrl}/${rel.attributes.objectid}/attachments/${a.id}`
                                ));
                            }
                        }
                    } catch(error) {
                        console.warn(`Table ${tableId} error:`, error.message);
                    }
                }
                return photos;
            }

            // Rest of lightbox and initialization code unchanged
        });
    </script>
</body>
</html>
