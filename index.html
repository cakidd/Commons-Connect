<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>The Commons 2.0 - Community Hub</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Permissions-Policy" content="web-share=(self)">
    <meta name="description" content="The Commons 2.0 - A community hub for Harmony for Hope">
    <meta name="theme-color" content="#2d4739">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://harmonyfrhope.org/favicon.png">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Calcite Components 3.1.0 -->
    <link rel="stylesheet" href="https://js.arcgis.com/calcite-components/3.1.0/calcite.css" />
    <script type="module" src="https://js.arcgis.com/calcite-components/3.1.0/calcite.esm.js"></script>
    
    <!-- ArcGIS JavaScript API -->
    <script src="https://js.arcgis.com/4.28/"></script>
    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
    
    <!-- Firebase Compat for easier migration -->
    <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-analytics-compat.js"></script>
    
    <!-- QR Code Generation -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

    <style>
        /* Core Variables */
        :root {
            /* Brand Colors */
            --primary: #2d4739;
            --secondary: #7a9a76;
            --accent: #ffd700;
            --accent-alt: #ff9500;
            
            /* UI Colors - Light Theme */
            --background: #f5f7f6;
            --card-bg: #ffffff;
            --card-border: rgba(122,154,118,0.15);
            --text-primary: rgba(45,71,57,0.9);
            --text-secondary: rgba(45,71,57,0.65);
            --divider: rgba(122,154,118,0.15);
            
            /* Shadows */
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 20px rgba(0,0,0,0.08);
            --shadow-lg: 0 10px 30px rgba(0,0,0,0.12);
            
            /* Typography */
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            
            /* Spacing */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            
            /* Border Radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --radius-xl: 28px;
            --radius-full: 9999px;
            
            /* Transition */
            --transition-fast: 0.15s ease;
            --transition-normal: 0.25s ease;
            --transition-slow: 0.35s ease;
            
            /* Z-index layers */
            --z-nav: 100;
            --z-dropdown: 200;
            --z-modal: 300;
            --z-toast: 400;
            --z-overlay: 500;
        }
        
        /* Dark Mode Variables */
        .theme-dark {
            --background: #1a2321;
            --card-bg: #2a3632;
            --card-border: rgba(122,154,118,0.2);
            --text-primary: rgba(255,255,255,0.9);
            --text-secondary: rgba(255,255,255,0.6);
            --divider: rgba(255,255,255,0.1);
            
            /* Adjusted shadows for dark mode */
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.15);
            --shadow-md: 0 4px 20px rgba(0,0,0,0.25);
            --shadow-lg: 0 10px 30px rgba(0,0,0,0.35);
        }
        
        /* Base Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        html {
            height: 100%;
            font-size: 16px;
        }
        
        body {
            font-family: var(--font-family);
            background: var(--background);
            color: var(--text-primary);
            min-height: 100%;
            display: flex;
            flex-direction: column;
            transition: background-color var(--transition-normal);
            padding-top: 70px; /* Space for fixed header */
            touch-action: pan-y;
        }
        
        a {
            color: var(--primary);
            text-decoration: none;
            transition: color var(--transition-fast);
        }
        
        a:hover {
            color: var(--accent-alt);
        }
        
        /* 2025 UI Trends - Typography */
        h1 {
            font-size: 2.75rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            margin-bottom: var(--space-lg);
        }
        
        h2 {
            font-size: 1.75rem;
            font-weight: 600;
            letter-spacing: -0.01em;
            margin-bottom: var(--space-md);
        }
        
        /* Layout */
        .container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding: 0 var(--space-md);
        }
        
        /* Header */
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 70px;
            background-color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--space-md);
            box-shadow: var(--shadow-md);
            z-index: var(--z-nav);
        }
        
        .app-logo {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            color: white;
            font-weight: 600;
            font-size: 1.4rem;
        }
        
        .app-logo img {
            height: 40px;
        }
        
        .nav-actions {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }
        
        /* 2025 UI Trends - Feed Cards */
        .feed-container {
            padding: var(--space-lg) 0;
        }
        
        .feed-item {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-lg);
            border: 1px solid var(--card-border);
            box-shadow: var(--shadow-md);
            position: relative;
            transition: transform var(--transition-normal), box-shadow var(--transition-normal);
            overflow: hidden;
        }
        
        .feed-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        /* Cool morphism effect - 2025 UI Trend */
        .feed-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent), var(--secondary));
            opacity: 0.8;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        }
        
        .feed-header {
            display: flex;
            gap: var(--space-md);
            align-items: center;
            margin-bottom: var(--space-md);
        }
        
        .feed-avatar {
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            border-radius: 50%;
            background: white;
            border: 2px solid var(--accent);
            box-shadow: var(--shadow-sm);
            flex-shrink: 0;
        }
        
        .feed-author-info {
            flex: 1;
        }
        
        .feed-author {
            font-weight: 600;
            font-size: 1.2rem;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }
        
        .verification-badge {
            color: var(--accent);
            font-size: 1rem;
        }
        
        .feed-meta {
            display: flex;
            gap: var(--space-md);
            font-size: 0.9rem;
            color: var(--text-secondary);
            flex-wrap: wrap;
        }
        
        .feed-options {
            position: absolute;
            top: var(--space-md);
            right: var(--space-md);
        }
        
        .category-tag {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: var(--radius-full);
            background: rgba(122,154,118,0.15);
            color: var(--primary);
            font-size: 0.85rem;
            font-weight: 500;
            border: 1px solid var(--card-border);
        }
        
        .feed-content {
            margin: var(--space-md) 0;
            line-height: 1.5;
        }
        
        /* 2025 UI Trends - Grid Layout */
        .feed-photos {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: var(--space-sm);
            margin: var(--space-md) 0;
        }
        
        .feed-photo {
            aspect-ratio: 1 / 1;
            width: 100%;
            height: auto;
            object-fit: cover;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: transform var(--transition-normal);
            border: 1px solid var(--card-border);
        }
        
        .feed-photo:hover {
            transform: scale(1.03);
        }
        
        /* 2025 UI Trends - Interaction Area */
        .feed-actions {
            display: flex;
            gap: var(--space-md);
            margin-top: var(--space-md);
            border-top: 1px solid var(--divider);
            padding-top: var(--space-md);
        }
        
        .feed-stats {
            display: flex;
            gap: var(--space-lg);
            margin-bottom: var(--space-sm);
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* 2025 UI Trends - Comments Section */
        .comments-section {
            margin-top: var(--space-md);
            border-top: 1px solid var(--divider);
            padding-top: var(--space-md);
        }
        
        .comments-list {
            max-height: 300px;
            overflow-y: auto;
            margin: var(--space-md) 0;
        }
        
        .comment-item {
            padding: var(--space-sm) 0;
            border-bottom: 1px solid var(--divider);
        }
        
        .comment-header {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin-bottom: var(--space-xs);
        }
        
        .comment-avatar {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            border-radius: 50%;
            background: white;
            border: 1px solid var(--accent);
        }
        
        .comment-author {
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .comment-text {
            font-size: 0.95rem;
            line-height: 1.4;
            margin-left: 40px; /* Align with author name */
        }
        
        .comment-meta {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: var(--space-xs);
            margin-left: 40px;
        }
        
        .comment-input-area {
            display: flex;
            gap: var(--space-sm);
            margin-top: var(--space-md);
        }
        
        /* 2025 UI Trends - Lightbox */
        .lightbox {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: var(--z-overlay);
            backdrop-filter: blur(5px);
            touch-action: none;
        }
        
        .lightbox.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .lightbox-content {
            position: relative;
            max-width: 90vw;
            max-height: 90vh;
        }
        
        .lightbox-img {
            max-width: 80vw;
            max-height: 80vh;
            object-fit: contain;
            border-radius: var(--radius-md);
        }
        
        .lightbox-nav {
            position: absolute;
            top: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.5);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            transform: translateY(-50%);
            transition: background var(--transition-fast);
        }
        
        .lightbox-nav:hover {
            background: rgba(0,0,0,0.8);
        }
        
        .lightbox-prev { left: 20px; }
        .lightbox-next { right: 20px; }
        
        /* 2025 UI Trends - Share Menu */
        .share-menu {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            box-shadow: var(--shadow-lg);
            z-index: var(--z-modal);
            padding: var(--space-lg);
            transform: translateY(100%);
            transition: transform var(--transition-normal);
            touch-action: none;
        }
        
        .share-menu.active {
            transform: translateY(0);
        }
        
        .share-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
        }
        
        .share-title {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .share-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }
        
        .share-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-xs);
            cursor: pointer;
        }
        
        .share-option-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(122,154,118,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: background var(--transition-fast);
        }
        
        .share-option:hover .share-option-icon {
            background: rgba(122,154,118,0.3);
        }
        
        .share-option-label {
            font-size: 0.8rem;
            text-align: center;
        }
        
        .share-link-area {
            display: flex;
            gap: var(--space-sm);
            margin-bottom: var(--space-md);
        }
        
        .qr-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: var(--space-md);
        }
        
        .qr-code {
            width: 150px;
            height: 150px;
            margin-bottom: var(--space-sm);
        }
        
        /* 2025 UI Trends - Reaction System */
        .reaction-menu {
            position: absolute;
            bottom: 100%;
            left: 0;
            background: var(--card-bg);
            border-radius: var(--radius-full);
            box-shadow: var(--shadow-md);
            display: flex;
            padding: var(--space-xs);
            margin-bottom: var(--space-xs);
            transform: scale(0.8);
            opacity: 0;
            transform-origin: bottom left;
            transition: transform var(--transition-fast), opacity var(--transition-fast);
            pointer-events: none;
        }
        
        .reaction-menu.active {
            transform: scale(1);
            opacity: 1;
            pointer-events: auto;
        }
        
        .reaction-option {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            border-radius: 50%;
            transition: transform var(--transition-fast), background var(--transition-fast);
        }
        
        .reaction-option:hover {
            transform: scale(1.2);
            background: rgba(122,154,118,0.15);
        }
        
        .reaction-summary {
            display: flex;
            align-items: center;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--radius-full);
            padding: 4px 8px 4px 4px;
            font-size: 0.9rem;
            margin-right: auto;
        }
        
        .reaction-icons {
            display: flex;
            margin-right: 4px;
        }
        
        .reaction-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: -8px;
            border: 2px solid var(--card-bg);
            font-size: 0.8rem;
        }
        
        .reaction-icon:first-child {
            margin-left: 0;
        }
        
        /* 2025 UI Trends - Create Post */
        .create-post {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: var(--space-md);
            margin-bottom: var(--space-lg);
            border: 1px solid var(--card-border);
            box-shadow: var(--shadow-md);
        }
        
        .create-post-header {
            display: flex;
            gap: var(--space-md);
            align-items: center;
            margin-bottom: var(--space-md);
        }
        
        .create-post-input {
            flex: 1;
            position: relative;
        }
        
        .create-post-button {
            margin-left: auto;
        }
        
        .attachment-previews {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-sm);
            margin-top: var(--space-md);
        }
        
        .attachment-preview {
            position: relative;
            width: 80px;
            height: 80px;
        }
        
        .attachment-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: var(--radius-sm);
        }
        
        .attachment-remove {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(255,0,0,0.8);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            cursor: pointer;
        }
        
        /* 2025 UI Trends - Notifications */
        .notification-menu {
            position: fixed;
            top: 70px;
            right: 0;
            width: 350px;
            max-width: 100%;
            height: calc(100% - 70px);
            background: var(--card-bg);
            box-shadow: var(--shadow-lg);
            z-index: var(--z-dropdown);
            transform: translateX(100%);
            transition: transform var(--transition-normal);
        }
        
        .notification-menu.active {
            transform: translateX(0);
        }
        
        .notification-header {
            padding: var(--space-md);
            border-bottom: 1px solid var(--divider);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .notification-list {
            height: calc(100% - 56px);
            overflow-y: auto;
        }
        
        .notification-item {
            padding: var(--space-md);
            border-bottom: 1px solid var(--divider);
            display: flex;
            gap: var(--space-md);
            transition: background var(--transition-fast);
            cursor: pointer;
        }
        
        .notification-item:hover {
            background: rgba(122,154,118,0.05);
        }
        
        .notification-item.unread {
            background: rgba(122,154,118,0.1);
        }
        
        .notification-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(122,154,118,0.15);
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        
        .notification-content {
            flex: 1;
        }
        
        .notification-text {
            margin-bottom: 4px;
            line-height: 1.4;
        }
        
        .notification-time {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        /* 2025 UI Trends - Loading Skeletons */
        .skeleton {
            background: linear-gradient(90deg, 
                var(--card-border) 0%, 
                rgba(255,255,255,0.5) 50%, 
                var(--card-border) 100%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: var(--radius-sm);
        }
        
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .skeleton-feed-item {
            padding: var(--space-lg);
            margin-bottom: var(--space-lg);
            border-radius: var(--radius-lg);
            background: var(--card-bg);
        }
        
        .skeleton-header {
            display: flex;
            gap: var(--space-md);
            margin-bottom: var(--space-md);
        }
        
        .skeleton-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
        }
        
        .skeleton-info {
            flex: 1;
        }
        
        .skeleton-name {
            height: 1.2rem;
            width: 40%;
            margin-bottom: var(--space-sm);
        }
        
        .skeleton-meta {
            height: 0.9rem;
            width: 60%;
        }
        
        .skeleton-content {
            height: 4rem;
            margin: var(--space-md) 0;
        }
        
        .skeleton-photos {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-sm);
            margin: var(--space-md) 0;
        }
        
        .skeleton-photo {
            aspect-ratio: 1 / 1;
            border-radius: var(--radius-md);
        }
        
        /* Animations */
        @keyframes fade-in {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        
        @keyframes slide-up {
            0% { transform: translateY(20px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* Animations for new elements */
        .new-element {
            animation: fade-in 0.5s ease forwards, slide-up 0.5s ease forwards;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            body {
                padding-top: 60px;
            }
            
            .app-header {
                height: 60px;
            }
            
            .app-logo {
                font-size: 1.1rem;
            }
            
            .app-logo img {
                height: 32px;
            }
            
            .feed-item {
                padding: var(--space-md);
            }
            
            .feed-header {
                gap: var(--space-sm);
            }
            
            .feed-avatar {
                width: 48px;
                height: 48px;
                font-size: 24px;
            }
            
            .feed-photos {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
            
            .share-options {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .notification-menu {
                width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            .feed-actions {
                flex-wrap: wrap;
                gap: var(--space-sm);
            }
            
            .share-options {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="app-header">
        <div class="app-logo">
            <img src="https://harmonyfrhope.org/wp-content/uploads/2022/09/Harmony-Logo-with-text-1.png" alt="The Commons Logo">
            <span>The Commons 2.0</span>
        </div>
        
        <div class="nav-actions">
            <calcite-button id="themeToggleBtn" icon="brightness" scale="m" appearance="transparent" color="neutral"></calcite-button>
            <calcite-button id="notificationsBtn" icon="notification" scale="m" appearance="transparent" color="neutral">
                <calcite-badge id="notificationsBadge" type="danger" hidden>0</calcite-badge>
            </calcite-button>
            <calcite-dropdown id="userDropdown">
                <calcite-button id="userButton" slot="trigger" scale="m" appearance="transparent" color="neutral">
                    <calcite-avatar id="userAvatar" scale="s" user-id="user1"></calcite-avatar>
                </calcite-button>
                <calcite-dropdown-group selection-mode="none">
                    <calcite-dropdown-item id="profileBtn" icon-start="user">Profile</calcite-dropdown-item>
                    <calcite-dropdown-item id="settingsBtn" icon-start="gear">Settings</calcite-dropdown-item>
                    <calcite-dropdown-item id="loginBtn" icon-start="sign-in">Sign In</calcite-dropdown-item>
                    <calcite-dropdown-item id="logoutBtn" icon-start="sign-out">Sign Out</calcite-dropdown-item>
                </calcite-dropdown-group>
            </calcite-dropdown>
        </div>
    </header>
    
    <!-- Main Content -->
    <main class="container">
        <!-- Create Post -->
        <div class="create-post" id="createPostArea">
            <div class="create-post-header">
                <calcite-avatar id="createPostAvatar" scale="m" user-id="user1"></calcite-avatar>
                <div class="create-post-input">
                    <calcite-input id="postInput" placeholder="What's on your mind?" scale="m"></calcite-input>
                </div>
            </div>
            
            <div class="attachment-previews" id="attachmentPreviews"></div>
            
            <calcite-button-group style="margin-top: 16px;">
                <calcite-button id="attachPhotoBtn" icon-start="image" appearance="outline" scale="m">Photo</calcite-button>
                <calcite-button id="attachLocationBtn" icon-start="pin" appearance="outline" scale="m">Location</calcite-button>
                <calcite-button id="createPostBtn" icon-start="send" appearance="solid" scale="m" width="auto" style="margin-left: auto;">Post</calcite-button>
            </calcite-button-group>
            
            <input type="file" id="photoInput" accept="image/*" multiple style="display: none;">
        </div>
        
        <!-- Feed -->
        <div class="feed-container" id="feed">
            <!-- Feed items will be inserted here -->
            <!-- Skeleton loading state -->
            <div class="skeleton-feed-item">
                <div class="skeleton-header">
                    <div class="skeleton skeleton-avatar"></div>
                    <div class="skeleton-info">
                        <div class="skeleton skeleton-name"></div>
                        <div class="skeleton skeleton-meta"></div>
                    </div>
                </div>
                <div class="skeleton skeleton-content"></div>
                <div class="skeleton-photos">
                    <div class="skeleton skeleton-photo"></div>
                    <div class="skeleton skeleton-photo"></div>
                    <div class="skeleton skeleton-photo"></div>
                </div>
            </div>
            
            <div class="skeleton-feed-item">
                <div class="skeleton-header">
                    <div class="skeleton skeleton-avatar"></div>
                    <div class="skeleton-info">
                        <div class="skeleton skeleton-name"></div>
                        <div class="skeleton skeleton-meta"></div>
                    </div>
                </div>
                <div class="skeleton skeleton-content"></div>
            </div>
        </div>
    </main>
    
    <!-- Lightbox -->
    <div class="lightbox" id="lightbox">
        <button class="lightbox-nav lightbox-prev" id="lightboxPrev" aria-label="Previous image">❮</button>
        <div class="lightbox-content">
            <img class="lightbox-img" id="lightboxImage" src="" alt="Enlarged image">
        </div>
        <button class="lightbox-nav lightbox-next" id="lightboxNext" aria-label="Next image">❯</button>
    </div>
    
    <!-- Share Menu -->
    <div class="share-menu" id="shareMenu">
        <div class="share-header">
            <div class="share-title">Share this post</div>
            <calcite-button appearance="transparent" scale="m" icon="x" id="closeShareBtn"></calcite-button>
        </div>
        
        <div class="share-options">
            <div class="share-option" data-share-type="facebook">
                <div class="share-option-icon">📱</div>
                <div class="share-option-label">Facebook</div>
            </div>
            <div class="share-option" data-share-type="twitter">
                <div class="share-option-icon">🐦</div>
                <div class="share-option-label">Twitter</div>
            </div>
            <div class="share-option" data-share-type="email">
                <div class="share-option-icon">📧</div>
                <div class="share-option-label">Email</div>
            </div>
            <div class="share-option" data-share-type="sms">
                <div class="share-option-icon">💬</div>
                <div class="share-option-label">SMS</div>
            </div>
            <div class="share-option" data-share-type="whatsapp">
                <div class="share-option-icon">📲</div>
                <div class="share-option-label">WhatsApp</div>
            </div>
            <div class="share-option" data-share-type="telegram">
                <div class="share-option-icon">📬</div>
                <div class="share-option-label">Telegram</div>
            </div>
            <div class="share-option" data-share-type="copy">
                <div class="share-option-icon">📋</div>
                <div class="share-option-label">Copy Link</div>
            </div>
            <div class="share-option" data-share-type="embed">
                <div class="share-option-icon">🔌</div>
                <div class="share-option-label">Embed</div>
            </div>
        </div>
        
        <div class="share-link-area">
            <calcite-input id="shareLink" readonly></calcite-input>
            <calcite-button id="copyLinkBtn" icon-start="copy" appearance="outline" scale="m">Copy</calcite-button>
        </div>
        
        <div class="qr-area">
            <div id="qrCode" class="qr-code"></div>
            <calcite-button id="downloadQrBtn" icon-start="download" appearance="outline" scale="s">Download QR Code</calcite-button>
        </div>
    </div>
    
    <!-- Notification Menu -->
    <div class="notification-menu" id="notificationMenu">
        <div class="notification-header">
            <div class="notification-title">Notifications</div>
            <calcite-button appearance="transparent" scale="m" icon="x" id="closeNotificationsBtn"></calcite-button>
        </div>
        
        <div class="notification-list" id="notificationList">
            <!-- Notifications will be inserted here -->
        </div>
    </div>
    
    <!-- Modals -->
    <calcite-modal id="loginModal" width="s" aria-labelledby="loginModalTitle">
        <h3 slot="header" id="loginModalTitle">Sign In</h3>
        <div slot="content">
            <div id="loginForm">
                <calcite-label>
                    Email
                    <calcite-input type="email" id="loginEmail" placeholder="email@example.com"></calcite-input>
                </calcite-label>
                <calcite-label style="margin-top: 16px;">
                    Password
                    <calcite-input type="password" id="loginPassword" placeholder="Your password"></calcite-input>
                </calcite-label>
                <div style="margin-top: 20px;">
                    <a href="#" id="forgotPasswordLink">Forgot password?</a>
                </div>
            </div>
            
            <div id="forgotPasswordForm" hidden>
                <calcite-label>
                    Email
                    <calcite-input type="email" id="resetEmail" placeholder="Enter your email"></calcite-input>
                </calcite-label>
                <div style="margin-top: 20px;">
                    <a href="#" id="backToLoginLink">Back to login</a>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--divider);">
                <p style="margin-bottom: 16px;">Or sign in with</p>
                <calcite-button-group>
                    <calcite-button id="googleLoginBtn" appearance="outline" icon-start="logo-google" scale="m">Google</calcite-button>
                    <calcite-button id="facebookLoginBtn" appearance="outline" icon-start="logo-facebook" scale="m">Facebook</calcite-button>
                </calcite-button-group>
            </div>
            
            <div style="text-align: center; margin-top: 24px;">
                <p>Don't have an account? <a href="#" id="signupLink">Sign up</a></p>
            </div>
        </div>
        <calcite-button slot="primary" id="loginWithEmailBtn">Sign In</calcite-button>
        <calcite-button slot="secondary" appearance="outline" id="cancelLoginBtn">Cancel</calcite-button>
    </calcite-modal>
    
    <calcite-modal id="signupModal" width="s" aria-labelledby="signupModalTitle">
        <h3 slot="header" id="signupModalTitle">Create Account</h3>
        <div slot="content">
            <calcite-label>
                Display Name
                <calcite-input type="text" id="signupName" placeholder="Your name"></calcite-input>
            </calcite-label>
            <calcite-label style="margin-top: 16px;">
                Email
                <calcite-input type="email" id="signupEmail" placeholder="email@example.com"></calcite-input>
            </calcite-label>
            <calcite-label style="margin-top: 16px;">
                Password
                <calcite-input type="password" id="signupPassword" placeholder="Create a strong password"></calcite-input>
            </calcite-label>
            <calcite-label style="margin-top: 16px;">
                Confirm Password
                <calcite-input type="password" id="signupConfirmPassword" placeholder="Confirm your password"></calcite-input>
            </calcite-label>
            
            <div style="margin-top: 24px;">
                <calcite-label layout="inline">
                    <calcite-checkbox id="termsCheckbox"></calcite-checkbox>
                    I agree to the <a href="#" target="_blank">Terms of Service</a> and <a href="#" target="_blank">Privacy Policy</a>
                </calcite-label>
            </div>
            
            <div style="text-align: center; margin-top: 24px;">
                <p>Already have an account? <a href="#" id="loginLink">Sign in</a></p>
            </div>
        </div>
        <calcite-button slot="primary" id="createAccountBtn">Create Account</calcite-button>
        <calcite-button slot="secondary" appearance="outline" id="cancelSignupBtn">Cancel</calcite-button>
    </calcite-modal>
    
    <calcite-modal id="commentModal" width="s" aria-labelledby="commentModalTitle">
        <h3 slot="header" id="commentModalTitle">Comments</h3>
        <div slot="content">
            <div class="comments-list" id="commentsList">
                <!-- Comments will be inserted here -->
            </div>
            
            <div class="comment-input-area">
                <calcite-avatar id="commentAvatar" scale="s" user-id="user1"></calcite-avatar>
                <calcite-text-area id="commentText" placeholder="Write a comment..." rows="3"></calcite-text-area>
            </div>
        </div>
        <calcite-button slot="primary" id="postCommentBtn">Post Comment</calcite-button>
        <calcite-button slot="secondary" appearance="outline" id="cancelCommentBtn">Close</calcite-button>
    </calcite-modal>
    
    <calcite-toast id="toast" kind="info"></calcite-toast>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDVPslNCSwV6_pxlUvQlT8p3qTDfpGMt-c",
            authDomain: "the-commons-2.firebaseapp.com",
            projectId: "the-commons-2",
            storageBucket: "the-commons-2.appspot.com",
            messagingSenderId: "53595932987",
            appId: "1:53595932987:web:9dcf1d5b3ef6260fa8cf1e",
            measurementId: "G-526FNHHQ5Y"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();
        const analytics = firebase.analytics();

        // Global state
        let userProfile = null;
        let currentMediaIndex = 0;
        let currentMediaArray = [];
        let currentPostId = null;
        let loadingMorePosts = false;
        let lastVisiblePost = null;
        let attachedFiles = [];
        let lastNotificationTimestamp = null;
        let isInitialLoad = true;
        
        // DOM Elements
        const feed = document.getElementById('feed');
        const createPostBtn = document.getElementById('createPostBtn');
        const postInput = document.getElementById('postInput');
        const photoInput = document.getElementById('photoInput');
        const attachPhotoBtn = document.getElementById('attachPhotoBtn');
        const attachmentPreviews = document.getElementById('attachmentPreviews');
        const lightbox = document.getElementById('lightbox');
        const lightboxImage = document.getElementById('lightboxImage');
        const lightboxPrev = document.getElementById('lightboxPrev');
        const lightboxNext = document.getElementById('lightboxNext');
        const shareMenu = document.getElementById('shareMenu');
        const closeShareBtn = document.getElementById('closeShareBtn');
        const shareLink = document.getElementById('shareLink');
        const copyLinkBtn = document.getElementById('copyLinkBtn');
        const qrCode = document.getElementById('qrCode');
        const downloadQrBtn = document.getElementById('downloadQrBtn');
        const notificationsBtn = document.getElementById('notificationsBtn');
        const notificationMenu = document.getElementById('notificationMenu');
        const closeNotificationsBtn = document.getElementById('closeNotificationsBtn');
        const notificationList = document.getElementById('notificationList');
        const notificationsBadge = document.getElementById('notificationsBadge');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const profileBtn = document.getElementById('profileBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const loginModal = document.getElementById('loginModal');
        const signupModal = document.getElementById('signupModal');
        const commentModal = document.getElementById('commentModal');
        const themeToggleBtn = document.getElementById('themeToggleBtn');
        const toast = document.getElementById('toast');
        
        // ArcGIS Configuration
        require(["esri/config", "esri/request"], function(esriConfig, esriRequest) {
            // Set CORS configuration
            esriConfig.request.useIdentity = false;
            esriConfig.request.trustedServers.push(
                "services7.arcgis.com",
                "firestore.googleapis.com",
                "firebasestorage.googleapis.com"
            );

            // Feature services configuration
            const MAIN_SERVICE_URL = "https://services7.arcgis.com/glzyAmcOgJqIUWmg/arcgis/rest/services/survey123_5cac06e4e94b43bfbdb2503852578fbf_results/FeatureServer";
            const MAIN_LAYER_URL = MAIN_SERVICE_URL + "/0";
            const PHOTO_TABLES = [1, 2, 3, 4]; // Related tables containing photos
            const POST_BATCH_SIZE = 10;
            
            // Category Icons Mapping
            const CATEGORY_ICONS = {
                yard_sale: '🏷️', 
                classified: '📦', 
                business: '🏢',
                csa: '🧺', 
                farmers_market: '🥕', 
                community_garden: '🌱',
                food_pantry: '🥫', 
                farm_stand: '🚜', 
                restaurant: '🍽️',
                educational_program: '🎓', 
                artisinal: '🧀', 
                barter_swap: '🤝',
                preservation: '🫙', 
                community_kitchen: '🍲', 
                default: '✨'
            };
            
            // ESRI Request wrapper with consistent CORS handling
            async function makeRequest(url, options = {}) {
                const corsOptions = {
                    ...options,
                    useIdentity: false,
                    credentials: "omit" // Explicitly omit credentials for CORS
                };
                
                try {
                    return await esriRequest(url, corsOptions);
                } catch (error) {
                    console.error('Request error:', error);
                    throw error;
                }
            }
            
            // Initialize the application
            function initApp() {
                // Set up auth state observer
                auth.onAuthStateChanged(user => {
                    if (user) {
                        // User is signed in
                        userProfile = {
                            uid: user.uid,
                            displayName: user.displayName || 'User',
                            email: user.email,
                            photoURL: user.photoURL
                        };
                        
                        // Update UI for authenticated user
                        loginBtn.style.display = 'none';
                        logoutBtn.style.display = 'block';
                        profileBtn.style.display = 'block';
                        
                        // Set avatar if user has profile picture
                        if (user.photoURL) {
                            document.getElementById('userAvatar').thumbnail = user.photoURL;
                            document.getElementById('createPostAvatar').thumbnail = user.photoURL;
                            document.getElementById('commentAvatar').thumbnail = user.photoURL;
                        } else {
                            document.getElementById('userAvatar').fullName = user.displayName || user.email;
                            document.getElementById('createPostAvatar').fullName = user.displayName || user.email;
                            document.getElementById('commentAvatar').fullName = user.displayName || user.email;
                        }
                        
                        // Show create post area
                        document.getElementById('createPostArea').style.display = 'block';
                        
                        // Subscribe to notifications
                        subscribeToNotifications();
                        
                        // Track user login
                        analytics.logEvent('login', {
                            method: user.providerData[0]?.providerId || 'unknown'
                        });
                    } else {
                        // User is signed out
                        userProfile = null;
                        
                        // Update UI for unauthenticated user
                        loginBtn.style.display = 'block';
                        logoutBtn.style.display = 'none';
                        profileBtn.style.display = 'none';
                        
                        // Reset avatars
                        document.getElementById('userAvatar').thumbnail = '';
                        document.getElementById('userAvatar').fullName = 'Guest';
                        
                        // Hide create post area
                        document.getElementById('createPostArea').style.display = 'none';
                    }
                });
                
                // Load posts
                loadPosts();
                
                // Set up infinite scroll
                setupInfiniteScroll();
                
                // Set up event listeners
                setupEventListeners();
                
                // Check theme preference
                checkThemePreference();
            }
            
            // Load posts from ArcGIS Feature Layer
            async function loadPosts(append = false) {
                if (loadingMorePosts) return;
                loadingMorePosts = true;
                
                try {
                    if (!append) {
                        feed.innerHTML = createSkeletonLoaders();
                    }
                    
                    // Build query
                    let query = {
                        where: "1=1",
                        outFields: "*",
                        orderByFields: "CreationDate DESC",
                        returnGeometry: true,
                        f: "json"
                    };
                    
                    // Pagination logic
                    if (lastVisiblePost && append) {
                        query.where = `CreationDate < '${lastVisiblePost}'`;
                    }
                    
                    // Limit batch size
                    query.resultRecordCount = POST_BATCH_SIZE;
                    
                    // Execute query
                    const { data: mainData } = await makeRequest(`${MAIN_LAYER_URL}/query`, { query });
                    
                    // Clear skeleton on first load
                    if (!append) {
                        feed.innerHTML = '';
                    }
                    
                    // Check if we have results
                    if (!mainData.features || mainData.features.length === 0) {
                        if (!append) {
                            feed.innerHTML = '<div style="text-align: center; padding: 20px;">No posts found. Be the first to post!</div>';
                        }
                        loadingMorePosts = false;
                        return;
                    }
                    
                    // Process features in parallel with Promise.all
                    await Promise.all(mainData.features.map(async feature => {
                        const attrs = feature.attributes;
                        
                        // Skip if we already have this post (can happen with pagination)
                        if (document.querySelector(`.feed-item[data-id="${attrs.globalid}"]`)) {
                            return;
                        }
                        
                        // Fetch photos for this post
                        const photos = await getPhotosForFeature(feature);
                        
                        // Get comments count
                        const commentsSnapshot = await db.collection('comments')
                            .where('postId', '==', attrs.globalid)
                            .get();
                        const commentsCount = commentsSnapshot.size;
                        
                        // Get reactions
                        const reactionsSnapshot = await db.collection('reactions')
                            .where('postId', '==', attrs.globalid)
                            .get();
                        const reactions = reactionsSnapshot.docs.map(doc => doc.data());
                        
                        // Create and render the post
                        const postElement = createPostElement(attrs, photos, commentsCount, reactions);
                        feed.appendChild(postElement);
                        
                        // Add animation class
                        setTimeout(() => {
                            postElement.classList.add('new-element');
                        }, 100);
                    }));
                    
                    // Update last visible post timestamp for pagination
                    if (mainData.features.length > 0) {
                        const lastFeature = mainData.features[mainData.features.length - 1];
                        lastVisiblePost = lastFeature.attributes.CreationDate;
                    }
                    
                    // Mark initial load complete
                    isInitialLoad = false;
                } catch (error) {
                    console.error("Failed to load posts:", error);
                    
                    if (!append) {
                        feed.innerHTML = `
                            <div style="text-align: center; padding: 20px;">
                                <p>Error loading posts. Please try again.</p>
                                <calcite-button onclick="window.location.reload()">Reload</calcite-button>
                            </div>
                        `;
                    } else {
                        showToast("Failed to load more posts", "danger");
                    }
                } finally {
                    loadingMorePosts = false;
                }
            }
            
            // Get photos for a feature
            async function getPhotosForFeature(feature) {
                const photos = [];
                const globalId = feature.attributes.globalid;
                const objectId = feature.attributes.objectid || feature.attributes.OBJECTID;
                
                // Check for direct attachments
                if (objectId) {
                    try {
                        const { data: directAttachments } = await makeRequest(
                            `${MAIN_LAYER_URL}/${objectId}/attachments?f=json`
                        );
                        
                        if (directAttachments?.attachmentInfos?.length) {
                            photos.push(...directAttachments.attachmentInfos.map(a => 
                                `${MAIN_LAYER_URL}/${objectId}/attachments/${a.id}`
                            ));
                        }
                    } catch (error) {
                        console.warn("Direct attachments error:", error.message);
                    }
                }
                
                // Check for related table attachments
                const tablePromises = PHOTO_TABLES.map(async tableId => {
                    const tableUrl = MAIN_LAYER_URL.replace("/0", `/${tableId}`);
                    try {
                        const { data: relatedData } = await makeRequest(`${tableUrl}/query`, {
                            query: {
                                where: `ParentGlobalID='${globalId}'`,
                                outFields: "objectid,OBJECTID",
                                f: "json"
                            }
                        });
                        
                        const attachmentPromises = (relatedData.features || []).map(async rel => {
                            const oid = rel.attributes.objectid || rel.attributes.OBJECTID;
                            if (!oid) return [];
                            
                            try {
                                const { data: attachments } = await makeRequest(
                                    `${tableUrl}/${oid}/attachments?f=json`
                                );
                                
                                if (attachments?.attachmentInfos?.length) {
                                    return attachments.attachmentInfos.map(a => 
                                        `${tableUrl}/${oid}/attachments/${a.id}`
                                    );
                                }
                                return [];
                            } catch (error) {
                                console.warn(`Attachment error for table ${tableId}, OID ${oid}:`, error.message);
                                return [];
                            }
                        });
                        
                        const attachmentResults = await Promise.all(attachmentPromises);
                        return attachmentResults.flat();
                    } catch (error) {
                        console.warn(`Table ${tableId} error:`, error.message);
                        return [];
                    }
                });
                
                const tableResults = await Promise.all(tablePromises);
                photos.push(...tableResults.flat());
                
                // Remove duplicates
                return [...new Set(photos)];
            }
            
            // Create post element
            function createPostElement(attrs, photos, commentsCount, reactions) {
                const card = document.createElement('div');
                card.className = 'feed-item';
                card.dataset.id = attrs.globalid;
                
                // Determine icon for category
                const iconKey = attrs.is_yard_sale ? 'yard_sale' :
                              attrs.is_classified ? 'classified' : 
                              attrs.category?.toLowerCase() || 'default';
                const icon = CATEGORY_ICONS[iconKey] || CATEGORY_ICONS.default;
                
                // Process reactions for display
                const reactionCounts = {};
                reactions.forEach(r => {
                    reactionCounts[r.type] = (reactionCounts[r.type] || 0) + 1;
                });
                
                const reactionTypes = Object.keys(reactionCounts);
                const totalReactions = reactions.length;
                
                // Determine if current user has reacted
                let userReaction = null;
                if (userProfile) {
                    const userReactionObj = reactions.find(r => r.userId === userProfile.uid);
                    if (userReactionObj) {
                        userReaction = userReactionObj.type;
                    }
                }
                
                // Create reaction summary HTML
                let reactionSummaryHTML = '';
                if (totalReactions > 0) {
                    reactionSummaryHTML = `
                        <div class="reaction-summary">
                            <div class="reaction-icons">
                                ${reactionTypes.slice(0, 3).map(type => `
                                    <div class="reaction-icon">${getReactionEmoji(type)}</div>
                                `).join('')}
                            </div>
                            <span>${totalReactions}</span>
                        </div>
                    `;
                }
                
                // Build HTML for card
                card.innerHTML = `
                    <div class="feed-options">
                        <calcite-dropdown>
                            <calcite-button slot="trigger" icon="ellipsis" appearance="transparent" scale="s"></calcite-button>
                            <calcite-dropdown-group selection-mode="none">
                                <calcite-dropdown-item id="shareBtn-${attrs.globalid}" icon-start="share">Share</calcite-dropdown-item>
                                <calcite-dropdown-item id="reportBtn-${attrs.globalid}" icon-start="exclamation-mark-triangle">Report</calcite-dropdown-item>
                            </calcite-dropdown-group>
                        </calcite-dropdown>
                    </div>
                    <div class="feed-header">
                        <div class="feed-avatar">
                            ${icon}
                        </div>
                        <div class="feed-author-info">
                            <div class="feed-author">
                                ${attrs.name || 'Community Member'}
                                ${attrs.verified ? '<span class="verification-badge">✓</span>' : ''}
                            </div>
                            <div class="feed-meta">
                                ${attrs.category ? `<span class="category-tag">${attrs.category}</span>` : ''}
                                ${attrs.sale_start ? `<span>📅 ${formatDate(attrs.sale_start)}</span>` : ''}
                                ${attrs.price ? `<span>💰 $${Number(attrs.price).toFixed(2)}</span>` : ''}
                                ${attrs.city || attrs.county ? `<span>📍 ${[attrs.city, attrs.county].filter(Boolean).join(', ')}</span>` : ''}
                                <span>🕒 ${formatRelativeTime(attrs.CreationDate)}</span>
                            </div>
                        </div>
                    </div>
                    ${attrs.classified_description || attrs.yard_sale_notes ? `
                        <div class="feed-content">
                            ${attrs.classified_description || attrs.yard_sale_notes}
                        </div>
                    ` : ''}
                    ${attrs.contact_name || attrs.phone || attrs.email ? `
                        <div style="margin-top: var(--space-md); font-size: 0.95em;">
                            ${attrs.contact_name ? `<div>👤 ${attrs.contact_name}</div>` : ''}
                            ${attrs.phone ? `<div>📞 <a href="tel:${attrs.phone}">${attrs.phone}</a></div>` : ''}
                            ${attrs.email ? `<div>📧 <a href="mailto:${attrs.email}">${attrs.email}</a></div>` : ''}
                        </div>
                    ` : ''}
                    ${photos.length ? `
                        <div class="feed-photos">
                            ${photos.map((url, index) => `
                                <img class="feed-photo" 
                                    src="${url}" 
                                    loading="lazy"
                                    alt="Post image ${index + 1}"
                                    onerror="this.style.display='none'"
                                    data-index="${index}">
                            `).join('')}
                        </div>
                    ` : ''}
                    <div class="feed-stats">
                        ${reactionSummaryHTML}
                        ${commentsCount > 0 ? `
                            <div class="stat-item comments-count">
                                <span>${commentsCount}</span> comment${commentsCount !== 1 ? 's' : ''}
                            </div>
                        ` : ''}
                    </div>
                    <div class="feed-actions">
                        <div class="reaction-wrapper" style="position: relative;">
                            <calcite-button 
                                class="reaction-btn ${userReaction ? 'reacted' : ''}" 
                                icon-start="${userReaction ? getReactionEmoji(userReaction) : '❤️'}" 
                                appearance="${userReaction ? 'solid' : 'outline'}"
                                color="${userReaction ? 'blue' : 'neutral'}"
                                scale="m"
                                data-post-id="${attrs.globalid}"
                            >${userReaction ? 'Liked' : 'Like'}</calcite-button>
                            <div class="reaction-menu" id="reactionMenu-${attrs.globalid}">
                                <div class="reaction-option" data-reaction="like" data-post-id="${attrs.globalid}">👍</div>
                                <div class="reaction-option" data-reaction="love" data-post-id="${attrs.globalid}">❤️</div>
                                <div class="reaction-option" data-reaction="haha" data-post-id="${attrs.globalid}">😂</div>
                                <div class="reaction-option" data-reaction="wow" data-post-id="${attrs.globalid}">😮</div>
                                <div class="reaction-option" data-reaction="sad" data-post-id="${attrs.globalid}">😢</div>
                            </div>
                        </div>
                        <calcite-button icon-start="speech-bubble" appearance="outline" scale="m" data-post-id="${attrs.globalid}" class="comment-btn">
                            Comment
                        </calcite-button>
                        <calcite-button icon-start="share" appearance="outline" scale="m" data-post-id="${attrs.globalid}" class="share-btn">
                            Share
                        </calcite-button>
                    </div>
                `;
                
                // Add event listeners
                addPostEventListeners(card, photos, attrs.globalid);
                
                return card;
            }
            
            // Add event listeners to post element
            function addPostEventListeners(postElement, photos, postId) {
                // Photo click listeners
                postElement.querySelectorAll('.feed-photo').forEach(img => {
                    img.addEventListener('click', () => {
                        openLightbox(photos, parseInt(img.dataset.index));
                    });
                });
                
                // Reaction button
                const reactionBtn = postElement.querySelector('.reaction-btn');
                if (reactionBtn) {
                    reactionBtn.addEventListener('click', () => {
                        toggleReactionMenu(postId);
                    });
                    
                    // Long press for mobile
                    let pressTimer;
                    reactionBtn.addEventListener('touchstart', () => {
                        pressTimer = setTimeout(() => {
                            toggleReactionMenu(postId);
                        }, 500);
                    });
                    
                    reactionBtn.addEventListener('touchend', () => {
                        clearTimeout(pressTimer);
                    });
                }
                
                // Reaction options
                postElement.querySelectorAll('.reaction-option').forEach(option => {
                    option.addEventListener('click', () => {
                        addReaction(option.dataset.postId, option.dataset.reaction);
                        document.getElementById(`reactionMenu-${postId}`).classList.remove('active');
                    });
                });
                
                // Comment button
                postElement.querySelector('.comment-btn').addEventListener('click', () => {
                    showComments(postId);
                });
                
                // Share button
                postElement.querySelector('.share-btn').addEventListener('click', () => {
                    sharePost(postId);
                });
                
                // Share dropdown option
                const shareDropdownBtn = postElement.querySelector(`#shareBtn-${postId}`);
                if (shareDropdownBtn) {
                    shareDropdownBtn.addEventListener('click', () => {
                        sharePost(postId);
                    });
                }
                
                // Report button
                const reportBtn = postElement.querySelector(`#reportBtn-${postId}`);
                if (reportBtn) {
                    reportBtn.addEventListener('click', () => {
                        reportPost(postId);
                    });
                }
            }
            
            // Create skeleton loaders
            function createSkeletonLoaders() {
                return `
                    <div class="skeleton-feed-item">
                        <div class="skeleton-header">
                            <div class="skeleton skeleton-avatar"></div>
                            <div class="skeleton-info">
                                <div class="skeleton skeleton-name"></div>
                                <div class="skeleton skeleton-meta"></div>
                            </div>
                        </div>
                        <div class="skeleton skeleton-content"></div>
                        <div class="skeleton-photos">
                            <div class="skeleton skeleton-photo"></div>
                            <div class="skeleton skeleton-photo"></div>
                            <div class="skeleton skeleton-photo"></div>
                        </div>
                    </div>
                    
                    <div class="skeleton-feed-item">
                        <div class="skeleton-header">
                            <div class="skeleton skeleton-avatar"></div>
                            <div class="skeleton-info">
                                <div class="skeleton skeleton-name"></div>
                                <div class="skeleton skeleton-meta"></div>
                            </div>
                        </div>
                        <div class="skeleton skeleton-content"></div>
                    </div>
                `;
            }
            
            // Lightbox functionality
            function openLightbox(mediaArray, index) {
                currentMediaArray = mediaArray;
                currentMediaIndex = index;
                
                lightboxImage.src = mediaArray[index];
                lightbox.classList.add('active');
                
                // Show/hide navigation based on number of items
                lightboxPrev.style.display = mediaArray.length > 1 ? 'flex' : 'none';
                lightboxNext.style.display = mediaArray.length > 1 ? 'flex' : 'none';
                
                // Track event
                analytics.logEvent('view_item', {
                    content_type: 'media',
                    item_id: currentMediaIndex
                });
            }
            
            function navigateLightbox(direction) {
                currentMediaIndex = (currentMediaIndex + direction + currentMediaArray.length) % currentMediaArray.length;
                lightboxImage.src = currentMediaArray[currentMediaIndex];
            }
            
            // Reaction system
            function toggleReactionMenu(postId) {
                // Check if user is logged in
                if (!userProfile) {
                    showToast("Please sign in to react to posts", "warning");
                    loginModal.open = true;
                    return;
                }
                
                const reactionMenu = document.getElementById(`reactionMenu-${postId}`);
                reactionMenu.classList.toggle('active');
                
                // Close menu when clicking outside
                function closeOnOutsideClick(e) {
                    if (!reactionMenu.contains(e.target) && !e.target.closest('.reaction-btn')) {
                        reactionMenu.classList.remove('active');
                        document.removeEventListener('click', closeOnOutsideClick);
                    }
                }
                
                setTimeout(() => {
                    document.addEventListener('click', closeOnOutsideClick);
                }, 10);
            }
            
            async function addReaction(postId, reactionType) {
                if (!userProfile) {
                    showToast("Please sign in to react to posts", "warning");
                    loginModal.open = true;
                    return;
                }
                
                try {
                    // Check if user already reacted to this post
                    const existingReactionQuery = await db.collection('reactions')
                        .where('postId', '==', postId)
                        .where('userId', '==', userProfile.uid)
                        .get();
                    
                    const batch = db.batch();
                    
                    if (!existingReactionQuery.empty) {
                        // Update existing reaction
                        existingReactionQuery.forEach(doc => {
                            batch.update(doc.ref, {
                                type: reactionType,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        });
                    } else {
                        // Create new reaction
                        const newReactionRef = db.collection('reactions').doc();
                        batch.set(newReactionRef, {
                            postId: postId,
                            userId: userProfile.uid,
                            userName: userProfile.displayName,
                            userPhoto: userProfile.photoURL,
                            type: reactionType,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    
                    await batch.commit();
                    
                    // Update UI
                    const reactionBtn = document.querySelector(`.reaction-btn[data-post-id="${postId}"]`);
                    reactionBtn.setAttribute('appearance', 'solid');
                    reactionBtn.setAttribute('color', 'blue');
                    reactionBtn.setAttribute('icon-start', getReactionEmoji(reactionType));
                    reactionBtn.textContent = 'Liked';
                    
                    // Track event
                    analytics.logEvent('reaction', {
                        content_type: 'post',
                        item_id: postId,
                        reaction_type: reactionType
                    });
                    
                    // Refresh post to update reaction count
                    setTimeout(() => {
                        refreshPost(postId);
                    }, 500);
                } catch (error) {
                    console.error("Error adding reaction:", error);
                    showToast("Failed to add reaction", "danger");
                }
            }
            
            function getReactionEmoji(reactionType) {
                const emojis = {
                    like: '👍',
                    love: '❤️',
                    haha: '😂',
                    wow: '😮',
                    sad: '😢'
                };
                
                return emojis[reactionType] || '👍';
            }
            
            // Comment system
            async function showComments(postId) {
                currentPostId = postId;
                
                try {
                    // Show skeleton loader
                    const commentsList = document.getElementById('commentsList');
                    commentsList.innerHTML = `
                        <div class="skeleton-comment">
                            <div class="skeleton skeleton-avatar" style="width: 32px; height: 32px; border-radius: 50%;"></div>
                            <div class="skeleton-comment-content" style="flex: 1;">
                                <div class="skeleton" style="height: 0.9rem; width: 30%; margin-bottom: 8px;"></div>
                                <div class="skeleton" style="height: 0.8rem; width: 90%;"></div>
                            </div>
                        </div>
                    `.repeat(3);
                    
                    // Fetch comments
                    const commentsSnapshot = await db.collection('comments')
                        .where('postId', '==', postId)
                        .orderBy('timestamp', 'desc')
                        .get();
                    
                    // Check if we have comments
                    if (commentsSnapshot.empty) {
                        commentsList.innerHTML = '<div style="text-align: center; padding: 16px;">No comments yet. Be the first!</div>';
                    } else {
                        commentsList.innerHTML = '';
                        
                        // Add comments to list
                        commentsSnapshot.forEach(doc => {
                            const data = doc.data();
                            const commentEl = document.createElement('div');
                            commentEl.className = 'comment-item';
                            commentEl.innerHTML = `
                                <div class="comment-header">
                                    <div class="comment-avatar">
                                        ${data.userPhoto ? `<img src="${data.userPhoto}" alt="${data.userName}" style="width: 100%; height: 100%; border-radius: 50%;">` : data.userName?.[0] || '👤'}
                                    </div>
                                    <div class="comment-author">${data.userName || 'Anonymous'}</div>
                                </div>
                                <div class="comment-text">${data.text}</div>
                                <div class="comment-meta">${formatRelativeTime(data.timestamp?.toDate())}</div>
                            `;
                            
                            commentsList.appendChild(commentEl);
                        });
                    }
                    
                    // Open modal
                    commentModal.open = true;
                    
                    // Focus comment input
                    setTimeout(() => {
                        document.getElementById('commentText').setFocus();
                    }, 300);
                    
                    // Track event
                    analytics.logEvent('view_comments', {
                        content_type: 'post',
                        item_id: postId
                    });
                } catch (error) {
                    console.error("Error loading comments:", error);
                    showToast("Failed to load comments", "danger");
                }
            }
            
            async function addComment(postId, text) {
                if (!userProfile) {
                    showToast("Please sign in to comment", "warning");
                    loginModal.open = true;
                    return;
                }
                
                if (!text.trim()) {
                    showToast("Comment cannot be empty", "warning");
                    return;
                }
                
                try {
                    // Add comment to Firestore
                    await db.collection('comments').add({
                        postId,
                        text: text.trim(),
                        userId: userProfile.uid,
                        userName: userProfile.displayName,
                        userPhoto: userProfile.photoURL,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Clear input
                    document.getElementById('commentText').value = '';
                    
                    // Reload comments
                    showComments(postId);
                    
                    // Update comments count on post
                    refreshPost(postId);
                    
                    // Track event
                    analytics.logEvent('add_comment', {
                        content_type: 'post',
                        item_id: postId
                    });
                } catch (error) {
                    console.error("Error adding comment:", error);
                    showToast("Failed to add comment", "danger");
                }
            }
            
            // Share system
            function sharePost(postId) {
                const postUrl = `https://the-commons-2.web.app/post/${postId}`;
                
                // Update share menu
                shareLink.value = postUrl;
                
                // Generate QR code
                QRCode.toCanvas(qrCode, postUrl, { width: 150 }, function(error) {
                    if (error) console.error(error);
                });
                
                // Open share menu
                shareMenu.classList.add('active');
                
                // Track event
                analytics.logEvent('share', {
                    content_type: 'post',
                    item_id: postId
                });
            }
            
            // Report post
            function reportPost(postId) {
                if (!userProfile) {
                    showToast("Please sign in to report posts", "warning");
                    loginModal.open = true;
                    return;
                }
                
                // Add report to Firestore
                db.collection('reports').add({
                    postId,
                    userId: userProfile.uid,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                })
                .then(() => {
                    showToast("Thank you for your report. We'll review it soon.", "info");
                })
                .catch(error => {
                    console.error("Error reporting post:", error);
                    showToast("Failed to submit report", "danger");
                });
            }
            
            // Refresh a post after interaction
            async function refreshPost(postId) {
                try {
                    // Get post element
                    const postElement = document.querySelector(`.feed-item[data-id="${postId}"]`);
                    if (!postElement) return;
                    
                    // Get comments count
                    const commentsSnapshot = await db.collection('comments')
                        .where('postId', '==', postId)
                        .get();
                    const commentsCount = commentsSnapshot.size;
                    
                    // Get reactions
                    const reactionsSnapshot = await db.collection('reactions')
                        .where('postId', '==', postId)
                        .get();
                    const reactions = reactionsSnapshot.docs.map(doc => doc.data());
                    
                    // Process reactions for display
                    const reactionCounts = {};
                    reactions.forEach(r => {
                        reactionCounts[r.type] = (reactionCounts[r.type] || 0) + 1;
                    });
                    
                    const reactionTypes = Object.keys(reactionCounts);
                    const totalReactions = reactions.length;
                    
                    // Determine if current user has reacted
                    let userReaction = null;
                    if (userProfile) {
                        const userReactionObj = reactions.find(r => r.userId === userProfile.uid);
                        if (userReactionObj) {
                            userReaction = userReactionObj.type;
                        }
                    }
                    
                    // Update reaction button
                    const reactionBtn = postElement.querySelector('.reaction-btn');
                    if (reactionBtn && userReaction) {
                        reactionBtn.setAttribute('appearance', 'solid');
                        reactionBtn.setAttribute('color', 'blue');
                        reactionBtn.setAttribute('icon-start', getReactionEmoji(userReaction));
                        reactionBtn.textContent = 'Liked';
                    } else if (reactionBtn) {
                        reactionBtn.setAttribute('appearance', 'outline');
                        reactionBtn.setAttribute('color', 'neutral');
                        reactionBtn.setAttribute('icon-start', '❤️');
                        reactionBtn.textContent = 'Like';
                    }
                    
                    // Update reaction summary
                    const feedStats = postElement.querySelector('.feed-stats');
                    if (feedStats) {
                        let reactionSummaryHTML = '';
                        if (totalReactions > 0) {
                            reactionSummaryHTML = `
                                <div class="reaction-summary">
                                    <div class="reaction-icons">
                                        ${reactionTypes.slice(0, 3).map(type => `
                                            <div class="reaction-icon">${getReactionEmoji(type)}</div>
                                        `).join('')}
                                    </div>
                                    <span>${totalReactions}</span>
                                </div>
                            `;
                        }
                        
                        let commentsHTML = '';
                        if (commentsCount > 0) {
                            commentsHTML = `
                                <div class="stat-item comments-count">
                                    <span>${commentsCount}</span> comment${commentsCount !== 1 ? 's' : ''}
                                </div>
                            `;
                        }
                        
                        feedStats.innerHTML = reactionSummaryHTML + commentsHTML;
                    }
                } catch (error) {
                    console.error("Error refreshing post:", error);
                }
            }
            
            // Create a new post
            async function createPost() {
                if (!userProfile) {
                    showToast("Please sign in to create a post", "warning");
                    loginModal.open = true;
                    return;
                }
                
                const postText = postInput.value.trim();
                
                if (!postText && attachedFiles.length === 0) {
                    showToast("Post cannot be empty", "warning");
                    return;
                }
                
                try {
                    // Show loading state
                    createPostBtn.loading = true;
                    
                    // Upload attached files if any
                    const uploadedFiles = [];
                    if (attachedFiles.length > 0) {
                        const uploadPromises = attachedFiles.map(async (file, index) => {
                            const storageRef = storage.ref(`posts/${userProfile.uid}/${Date.now()}_${index}_${file.name}`);
                            await storageRef.put(file);
                            return storageRef.getDownloadURL();
                        });
                        
                        uploadedFiles.push(...await Promise.all(uploadPromises));
                    }
                    
                    // Create post in Firestore
                    const postRef = await db.collection('posts').add({
                        text: postText,
                        photos: uploadedFiles,
                        userId: userProfile.uid,
                        userName: userProfile.displayName,
                        userPhoto: userProfile.photoURL,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        likeCount: 0,
                        commentCount: 0
                    });
                    
                    // Clear form
                    postInput.value = '';
                    attachedFiles = [];
                    attachmentPreviews.innerHTML = '';
                    
                    // Show success message
                    showToast("Post created successfully", "success");
                    
                    // Add the new post to the top of the feed
                    const newPost = {
                        id: postRef.id,
                        text: postText,
                        photos: uploadedFiles,
                        userId: userProfile.uid,
                        userName: userProfile.displayName,
                        userPhoto: userProfile.photoURL,
                        timestamp: new Date(),
                        likeCount: 0,
                        commentCount: 0
                    };
                    
                    // TODO: Add the post to the UI
                    
                    // Track event
                    analytics.logEvent('create_post', {
                        content_type: 'post'
                    });
                } catch (error) {
                    console.error("Error creating post:", error);
                    showToast("Failed to create post", "danger");
                } finally {
                    createPostBtn.loading = false;
                }
            }
            
            // Notification system
            async function subscribeToNotifications() {
                if (!userProfile) return;
                
                try {
                    // Get last notification timestamp
                    const userRef = db.collection('users').doc(userProfile.uid);
                    const userDoc = await userRef.get();
                    
                    if (userDoc.exists) {
                        lastNotificationTimestamp = userDoc.data().lastNotificationTimestamp?.toDate();
                    }
                    
                    // Real-time listener for new notifications
                    db.collection('notifications')
                        .where('userId', '==', userProfile.uid)
                        .where('read', '==', false)
                        .onSnapshot(snapshot => {
                            // Update notification badge
                            notificationsBadge.textContent = snapshot.size;
                            notificationsBadge.hidden = snapshot.size === 0;
                            
                            // Show notification toast for new items
                            snapshot.docChanges().forEach(change => {
                                if (change.type === 'added') {
                                    const notification = change.doc.data();
                                    
                                    // Only show toast for new notifications
                                    const notificationTime = notification.timestamp?.toDate();
                                    if (lastNotificationTimestamp && notificationTime && notificationTime > lastNotificationTimestamp) {
                                        showNotificationToast(notification);
                                    }
                                }
                            });
                            
                            // Update last notification timestamp
                            if (snapshot.size > 0) {
                                lastNotificationTimestamp = new Date();
                                userRef.update({
                                    lastNotificationTimestamp: firebase.firestore.FieldValue.serverTimestamp()
                                });
                            }
                        });
                } catch (error) {
                    console.error("Error subscribing to notifications:", error);
                }
            }
            
            function showNotificationToast(notification) {
                // Create toast with notification content
                toast.label = notification.title || 'New notification';
                toast.message = notification.message || '';
                toast.kind = 'info';
                toast.open = true;
                
                // Play notification sound
                playNotificationSound();
            }
            
            async function loadNotifications() {
                if (!userProfile) return;
                
                try {
                    // Show loading skeleton
                    notificationList.innerHTML = `
                        <div class="notification-item">
                            <div class="skeleton" style="width: 40px; height: 40px; border-radius: 50%;"></div>
                            <div style="flex: 1;">
                                <div class="skeleton" style="height: 0.9rem; width: 90%; margin-bottom: 8px;"></div>
                                <div class="skeleton" style="height: 0.8rem; width: 40%;"></div>
                            </div>
                        </div>
                    `.repeat(5);
                    
                    // Fetch notifications
                    const notificationsSnapshot = await db.collection('notifications')
                        .where('userId', '==', userProfile.uid)
                        .orderBy('timestamp', 'desc')
                        .limit(20)
                        .get();
                    
                    // Clear loading skeletons
                    notificationList.innerHTML = '';
                    
                    // Check if we have notifications
                    if (notificationsSnapshot.empty) {
                        notificationList.innerHTML = '<div style="text-align: center; padding: 16px;">No notifications yet.</div>';
                        return;
                    }
                    
                    // Add notifications to list
                    notificationsSnapshot.forEach(doc => {
                        const data = doc.data();
                        const notificationEl = document.createElement('div');
                        notificationEl.className = `notification-item ${data.read ? '' : 'unread'}`;
                        notificationEl.dataset.id = doc.id;
                        
                        // Icon based on notification type
                        let icon = '🔔';
                        if (data.type === 'like') icon = '❤️';
                        if (data.type === 'comment') icon = '💬';
                        if (data.type === 'follow') icon = '👥';
                        if (data.type === 'mention') icon = '@️';
                        
                        notificationEl.innerHTML = `
                            <div class="notification-avatar">
                                ${icon}
                            </div>
                            <div class="notification-content">
                                <div class="notification-text">${data.message}</div>
                                <div class="notification-time">${formatRelativeTime(data.timestamp?.toDate())}</div>
                            </div>
                        `;
                        
                        // Add click handler to mark as read and navigate
                        notificationEl.addEventListener('click', () => {
                            markNotificationAsRead(doc.id);
                            
                            // Handle navigation based on notification type
                            if (data.postId) {
                                // TODO: Navigate to post
                                notificationMenu.classList.remove('active');
                            }
                        });
                        
                        notificationList.appendChild(notificationEl);
                    });
                } catch (error) {
                    console.error("Error loading notifications:", error);
                    notificationList.innerHTML = '<div style="text-align: center; color: red; padding: 16px;">Failed to load notifications.</div>';
                }
            }
            
            async function markNotificationAsRead(notificationId) {
                try {
                    await db.collection('notifications').doc(notificationId).update({
                        read: true
                    });
                    
                    // Update UI
                    const notificationEl = document.querySelector(`.notification-item[data-id="${notificationId}"]`);
                    if (notificationEl) {
                        notificationEl.classList.remove('unread');
                    }
                } catch (error) {
                    console.error("Error marking notification as read:", error);
                }
            }
            
            async function markAllNotificationsAsRead() {
                if (!userProfile) return;
                
                try {
                    // Get all unread notifications
                    const unreadSnapshot = await db.collection('notifications')
                        .where('userId', '==', userProfile.uid)
                        .where('read', '==', false)
                        .get();
                    
                    // No unread notifications
                    if (unreadSnapshot.empty) return;
                    
                    // Batch update all notifications
                    const batch = db.batch();
                    unreadSnapshot.forEach(doc => {
                        batch.update(doc.ref, { read: true });
                    });
                    
                    await batch.commit();
                    
                    // Update UI
                    document.querySelectorAll('.notification-item.unread').forEach(el => {
                        el.classList.remove('unread');
                    });
                    
                    // Update badge
                    notificationsBadge.textContent = '0';
                    notificationsBadge.hidden = true;
                    
                    showToast("All notifications marked as read", "success");
                } catch (error) {
                    console.error("Error marking all notifications as read:", error);
                    showToast("Failed to mark notifications as read", "danger");
                }
            }
            
            // Setup infinite scroll
            function setupInfiniteScroll() {
                // Create observer
                const observer = new IntersectionObserver(entries => {
                    entries.forEach(entry => {
                        // If last feed item is visible, load more posts
                        if (entry.isIntersecting && !loadingMorePosts && !isInitialLoad) {
                            loadPosts(true);
                        }
                    });
                }, {
                    root: null,
                    rootMargin: '0px 0px 200px 0px', // Load more when within 200px of bottom
                    threshold: 0.1
                });
                
                // Function to observe last feed item
                function observeLastPost() {
                    const feedItems = document.querySelectorAll('.feed-item');
                    if (feedItems.length > 0) {
                        const lastItem = feedItems[feedItems.length - 1];
                        observer.observe(lastItem);
                    }
                }
                
                // Initial observation
                setTimeout(observeLastPost, 1000);
                
                // Re-observe when feed content changes
                const feedObserver = new MutationObserver(observeLastPost);
                feedObserver.observe(feed, { childList: true });
            }
            
            // Setup event listeners
            function setupEventListeners() {
                // Lightbox close
                lightbox.addEventListener('click', e => {
                    if (e.target === lightbox) {
                        lightbox.classList.remove('active');
                    }
                });
                
                // Lightbox navigation
                lightboxPrev.addEventListener('click', () => navigateLightbox(-1));
                lightboxNext.addEventListener('click', () => navigateLightbox(1));
                
                // Post comment button
                document.getElementById('postCommentBtn').addEventListener('click', () => {
                    const commentText = document.getElementById('commentText').value;
                    addComment(currentPostId, commentText);
                });
                
                // Cancel comment button
                document.getElementById('cancelCommentBtn').addEventListener('click', () => {
                    commentModal.open = false;
                });
                
                // Share options
                document.querySelectorAll('.share-option').forEach(option => {
                    option.addEventListener('click', () => {
                        const shareType = option.dataset.shareType;
                        const url = shareLink.value;
                        
                        switch (shareType) {
                            case 'facebook':
                                window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`, '_blank');
                                break;
                            case 'twitter':
                                window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent('Check out this post!')}&url=${encodeURIComponent(url)}`, '_blank');
                                break;
                            case 'email':
                                window.open(`mailto:?subject=Check out this post&body=${encodeURIComponent(url)}`, '_blank');
                                break;
                            case 'sms':
                                window.open(`sms:?body=${encodeURIComponent(url)}`, '_blank');
                                break;
                            case 'whatsapp':
                                window.open(`https://wa.me/?text=${encodeURIComponent(url)}`, '_blank');
                                break;
                            case 'telegram':
                                window.open(`https://t.me/share/url?url=${encodeURIComponent(url)}`, '_blank');
                                break;
                            case 'copy':
                                copyToClipboard(url);
                                break;
                            case 'embed':
                                // Show embed code
                                const embedCode = `<iframe src="${url}" width="100%" height="500" frameborder="0"></iframe>`;
                                copyToClipboard(embedCode);
                                showToast("Embed code copied to clipboard", "success");
                                break;
                        }
                        
                        shareMenu.classList.remove('active');
                    });
                });
                
                // Close share menu
                closeShareBtn.addEventListener('click', () => {
                    shareMenu.classList.remove('active');
                });
                
                // Copy link button
                copyLinkBtn.addEventListener('click', () => {
                    copyToClipboard(shareLink.value);
                });
                
                // Download QR code
                downloadQrBtn.addEventListener('click', () => {
                    const canvas = qrCode.querySelector('canvas');
                    if (canvas) {
                        const link = document.createElement('a');
                        link.download = 'qrcode.png';
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                    }
                });
                
                // Notification button
                notificationsBtn.addEventListener('click', () => {
                    notificationMenu.classList.toggle('active');
                    
                    if (notificationMenu.classList.contains('active')) {
                        loadNotifications();
                    }
                });
                
                // Close notifications
                closeNotificationsBtn.addEventListener('click', () => {
                    notificationMenu.classList.remove('active');
                });
                
                // Create post button
                createPostBtn.addEventListener('click', createPost);
                
                // Attach photo button
                attachPhotoBtn.addEventListener('click', () => {
                    photoInput.click();
                });
                
                // Handle photo selection
                photoInput.addEventListener('change', e => {
                    if (e.target.files && e.target.files.length > 0) {
                        handleFileSelection(e.target.files);
                    }
                });
                
                // Theme toggle
                themeToggleBtn.addEventListener('click', toggleTheme);
                
                // Login button
                loginBtn.addEventListener('click', () => {
                    loginModal.open = true;
                });
                
                // Logout button
                logoutBtn.addEventListener('click', signOut);
                
                // Sign up link
                document.getElementById('signupLink').addEventListener('click', () => {
                    loginModal.open = false;
                    signupModal.open = true;
                });
                
                // Login link
                document.getElementById('loginLink').addEventListener('click', () => {
                    signupModal.open = false;
                    loginModal.open = true;
                });
                
                // Forgot password link
                document.getElementById('forgotPasswordLink').addEventListener('click', () => {
                    document.getElementById('loginForm').hidden = true;
                    document.getElementById('forgotPasswordForm').hidden = false;
                });
                
                // Back to login link
                document.getElementById('backToLoginLink').addEventListener('click', () => {
                    document.getElementById('loginForm').hidden = false;
                    document.getElementById('forgotPasswordForm').hidden = true;
                });
                
                // Login with email button
                document.getElementById('loginWithEmailBtn').addEventListener('click', signInWithEmail);
                
                // Create account button
                document.getElementById('createAccountBtn').addEventListener('click', createAccount);
                
                // Google login button
                document.getElementById('googleLoginBtn').addEventListener('click', signInWithGoogle);
                
                // Facebook login button
                document.getElementById('facebookLoginBtn').addEventListener('click', signInWithFacebook);
            }
            
            // Handle file selection for post creation
            function handleFileSelection(files) {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    
                    // Skip non-image files
                    if (!file.type.startsWith('image/')) continue;
                    
                    // Limit to 5 files
                    if (attachedFiles.length >= 5) {
                        showToast("Maximum 5 images allowed", "warning");
                        break;
                    }
                    
                    // Add to array
                    attachedFiles.push(file);
                    
                    // Create preview
                    const preview = document.createElement('div');
                    preview.className = 'attachment-preview';
                    preview.innerHTML = `
                        <img src="${URL.createObjectURL(file)}" alt="Attachment preview">
                        <div class="attachment-remove" data-index="${attachedFiles.length - 1}">×</div>
                    `;
                    
                    // Add to previews
                    attachmentPreviews.appendChild(preview);
                    
                    // Add remove handler
                    preview.querySelector('.attachment-remove').addEventListener('click', function() {
                        const index = parseInt(this.dataset.index);
                        attachedFiles.splice(index, 1);
                        preview.remove();
                        
                        // Update indexes
                        document.querySelectorAll('.attachment-remove').forEach((el, i) => {
                            el.dataset.index = i;
                        });
                    });
                }
            }
            
            // Authentication functions
            async function signInWithEmail() {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                if (!email || !password) {
                    showToast("Please enter email and password", "warning");
                    return;
                }
                
                try {
                    document.getElementById('loginWithEmailBtn').loading = true;
                    await auth.signInWithEmailAndPassword(email, password);
                    loginModal.open = false;
                    showToast("Signed in successfully", "success");
                } catch (error) {
                    console.error("Login error:", error);
                    showToast("Login failed: " + error.message, "danger");
                } finally {
                    document.getElementById('loginWithEmailBtn').loading = false;
                }
            }
            
            async function createAccount() {
                const name = document.getElementById('signupName').value;
                const email = document.getElementById('signupEmail').value;
                const password = document.getElementById('signupPassword').value;
                const confirmPassword = document.getElementById('signupConfirmPassword').value;
                const termsAccepted = document.getElementById('termsCheckbox').checked;
                
                if (!name || !email || !password) {
                    showToast("Please fill all required fields", "warning");
                    return;
                }
                
                if (password !== confirmPassword) {
                    showToast("Passwords do not match", "warning");
                    return;
                }
                
                if (!termsAccepted) {
                    showToast("Please accept the terms of service", "warning");
                    return;
                }
                
                try {
                    document.getElementById('createAccountBtn').loading = true;
                    
                    // Create account
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    
                    // Update profile
                    await userCredential.user.updateProfile({
                        displayName: name
                    });
                    
                    // Create user document
                    await db.collection('users').doc(userCredential.user.uid).set({
                        displayName: name,
                        email: email,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastActive: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    signupModal.open = false;
                    showToast("Account created successfully", "success");
                } catch (error) {
                    console.error("Signup error:", error);
                    showToast("Sign up failed: " + error.message, "danger");
                } finally {
                    document.getElementById('createAccountBtn').loading = false;
                }
            }
            
            async function signInWithGoogle() {
                try {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    await auth.signInWithPopup(provider);
                    loginModal.open = false;
                    showToast("Signed in with Google", "success");
                } catch (error) {
                    console.error("Google login error:", error);
                    showToast("Google login failed: " + error.message, "danger");
                }
            }
            
            async function signInWithFacebook() {
                try {
                    const provider = new firebase.auth.FacebookAuthProvider();
                    await auth.signInWithPopup(provider);
                    loginModal.open = false;
                    showToast("Signed in with Facebook", "success");
                } catch (error) {
                    console.error("Facebook login error:", error);
                    showToast("Facebook login failed: " + error.message, "danger");
                }
            }
            
            async function signOut() {
                try {
                    await auth.signOut();
                    showToast("Signed out successfully", "success");
                } catch (error) {
                    console.error("Sign out error:", error);
                    showToast("Failed to sign out", "danger");
                }
            }
            
            // Helper functions
            function copyToClipboard(text) {
                navigator.clipboard.writeText(text)
                    .then(() => {
                        showToast("Copied to clipboard", "success");
                    })
                    .catch(err => {
                        console.error('Copy failed:', err);
                        showToast("Failed to copy to clipboard", "danger");
                    });
            }
            
            function showToast(message, kind = "info") {
                toast.label = message;
                toast.kind = kind;
                toast.open = true;
            }
            
            function playNotificationSound() {
                const audio = new Audio('https://firebasestorage.googleapis.com/v0/b/the-commons-2.appspot.com/o/notification.mp3?alt=media');
                audio.play().catch(err => console.log('Audio play prevented:', err));
            }
            
            function formatDate(timestamp) {
                if (!timestamp) return '';
                
                const date = new Date(timestamp);
                return date.toLocaleDateString();
            }
            
            function formatRelativeTime(timestamp) {
                if (!timestamp) return '';
                
                const now = new Date();
                const date = new Date(timestamp);
                const diff = Math.floor((now - date) / 1000); // Difference in seconds
                
                if (diff < 60) return 'Just now';
                if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
                if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
                if (diff < 604800) return `${Math.floor(diff / 86400)}d ago`;
                
                return date.toLocaleDateString();
            }
            
            function toggleTheme() {
                const isDark = document.body.classList.toggle('theme-dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                themeToggleBtn.icon = isDark ? 'brightness' : 'moon';
            }
            
            function checkThemePreference() {
                const savedTheme = localStorage.getItem('theme');
                
                if (savedTheme === 'dark') {
                    document.body.classList.add('theme-dark');
                    themeToggleBtn.icon = 'brightness';
                } else if (savedTheme === 'light') {
                    document.body.classList.remove('theme-dark');
                    themeToggleBtn.icon = 'moon';
                } else {
                    // Check system preference
                    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    if (prefersDark) {
                        document.body.classList.add('theme-dark');
                        themeToggleBtn.icon = 'brightness';
                    }
                }
            }
            
            // Initialize the app
            initApp();
        });
    </script>
</body>
</html>
