<!DOCTYPE html>
<html>
<head>
    <title>Community Feed - The Commons</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://js.arcgis.com/4.28/"></script>
    <style>
        /* ... (keep all existing styles unchanged) ... */
    </style>
</head>
<body>
    <!-- ... (keep GDPR consent banner unchanged) ... -->
    
    <div class="feed-container" id="feed">
        <div class="loader"></div>
    </div>
    <button id="refresh">‚ü≥ Refresh</button>

    <script>
        require(["esri/config", "esri/identity/IdentityManager", "esri/request"], 
        function(esriConfig, esriId, esriRequest) {
            
        // FIX 1: Correct service URL (Line 130)
        const config = {
            featureLayerUrl: "https://services7.arcgis.com/glzyAmcOgJqIUWmg/arcgis/rest/services/survey123_5cac06e4e94b43bfbdb2503852578fbf_results/FeatureServer/0",
            maxRetries: 3,
            retryDelay: 2000,
            requestTimeout: 10000
        };

        // FIX 2: Proper token handling (Line 147)
        esriConfig.request.interceptors.push({
            urls: /services7.arcgis.com/,
            before: async (params) => {
                if (await isSecureService(params.url)) {
                    const token = await getToken();
                    params.requestOptions.query = {
                        ...params.requestOptions.query,
                        token: token
                    };
                }
                return params;
            }
        });

        // ... (keep existing helper functions unchanged) ...

        async function loadFeed() {
            try {
                const feed = document.getElementById("feed");
                feed.innerHTML = '<div class="loader"></div>';
                
                // FIX 3: Simplified where clause (Line 163)
                const queryParams = new URLSearchParams({
                    where: "1=1",
                    outFields: "*",
                    orderByFields: "CreationDate DESC", 
                    f: "json"
                });

                const data = await fetchWithRetry(
                    `${config.featureLayerUrl}/query?${queryParams}`
                );

                feed.innerHTML = "";
                
                if (!data.features?.length) {
                    showMessage("No active listings found");
                    return;
                }

                // ... (keep existing feature rendering logic) ...
                
            } catch (error) {
                console.error("Feed load failed:", error);
                showMessage(`Error loading feed: ${error.message}`);
            }
        }

        // FIX 4: Adjusted error handling (Line 426)
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
            if (document.getElementById('feed').innerHTML.includes('loader')) {
                setTimeout(() => {
                    if (document.getElementById('feed').innerHTML.includes('loader')) {
                        showMessage(`Error: ${event.message}`);
                    }
                }, 10000);
            }
        });

        // ... (keep remaining code unchanged) ...
        });
    </script>
</body>
</html>
