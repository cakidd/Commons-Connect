<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase MountainShares - The Commons</title>
    <style>
        :root {
            --wv-blue: #1e3a8a;
            --wv-gold: #fbbf24;
            --mountain-dark: #1f2937;
            --mountain-light: #374151;
            --mountain-white: #f9fafb;
            --success-green: #10b981;
            --error-red: #ef4444;
            --warning-yellow: #f59e0b;
            --gold-gradient: linear-gradient(135deg, #fbbf24, #f59e0b);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--mountain-dark) 0%, var(--wv-blue) 100%);
            color: var(--mountain-white);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 3em;
            background: var(--gold-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 15px;
        }

        .header p {
            font-size: 1.2em;
            color: var(--mountain-white);
            opacity: 0.9;
        }

        .purchase-section {
            background: var(--mountain-light);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            border: 2px solid var(--wv-gold);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .input-group {
            margin-bottom: 25px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--wv-gold);
        }

        .input-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--mountain-dark);
            border-radius: 12px;
            background: var(--mountain-dark);
            color: var(--mountain-white);
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--wv-gold);
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.2);
        }

        .price-display {
            background: var(--mountain-dark);
            padding: 25px;
            border-radius: 15px;
            margin: 25px 0;
            border: 2px solid var(--wv-gold);
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .price-row.total {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--wv-gold);
            border-top: 2px solid var(--wv-gold);
            padding-top: 15px;
            margin-top: 15px;
        }

        .wallet-section {
            background: rgba(251, 191, 36, 0.1);
            padding: 20px;
            border-radius: 12px;
            margin: 25px 0;
            border: 1px solid var(--wv-gold);
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: var(--gold-gradient);
            color: var(--mountain-dark);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(251, 191, 36, 0.3);
        }

        .btn-secondary {
            background: var(--mountain-dark);
            color: var(--mountain-white);
            border: 2px solid var(--wv-gold);
        }

        .btn-secondary:hover {
            background: var(--wv-gold);
            color: var(--mountain-dark);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status-message {
            padding: 15px;
            border-radius: 12px;
            margin: 20px 0;
            font-weight: 600;
            border: 2px solid;
        }

        .status-success {
            background: rgba(16, 185, 129, 0.2);
            border-color: var(--success-green);
            color: var(--success-green);
        }

        .status-error {
            background: rgba(239, 68, 68, 0.2);
            border-color: var(--error-red);
            color: var(--error-red);
        }

        .status-warning {
            background: rgba(245, 158, 11, 0.2);
            border-color: var(--warning-yellow);
            color: var(--warning-yellow);
        }

        .network-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            z-index: 1000;
        }

        .network-online {
            background: var(--success-green);
            color: white;
        }

        .network-offline {
            background: var(--error-red);
            color: white;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 40px;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .feature-card h3 {
            color: var(--wv-gold);
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .purchase-section {
                padding: 20px;
            }
            
            .price-row {
                font-size: 1em;
            }
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--mountain-dark);
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            border: 3px solid var(--wv-gold);
            text-align: center;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .transaction-details {
            background: rgba(0, 255, 0, 0.1);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            border: 2px solid #44ff44;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--wv-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="network-status" id="network-status">üåê Online</div>

    <div class="container">
        <div class="header">
            <h1>üíé Purchase MountainShares</h1>
            <p>Digital currency that strengthens West Virginia communities</p>
        </div>

        <div class="purchase-section">
            <h2 style="color: var(--wv-gold); margin-bottom: 30px; text-align: center;">
                üèîÔ∏è Get Your MountainShares
            </h2>

            <div class="input-group">
                <label for="ms-quantity">How many MountainShares do you want?</label>
                <input type="number" id="ms-quantity" min="1" value="10" placeholder="Enter quantity">
            </div>

            <div class="price-display" id="pricing-display">
                <div class="price-row">
                    <span>üíé MountainShares Price:</span>
                    <span id="ms-price">$1.00 each</span>
                </div>
                <div class="price-row">
                    <span>üí≥ Processing Fee (3.5%):</span>
                    <span id="processing-fee">$0.35</span>
                </div>
                <div class="price-row total">
                    <span>üí∞ Total Charge:</span>
                    <span id="total-price">$10.35</span>
                </div>
            </div>

            <div class="wallet-section">
                <h3 style="color: var(--wv-gold); margin-bottom: 15px;">üîê Wallet Connection</h3>
                <div class="input-group">
                    <label for="wallet-address">Your Ethereum Wallet Address:</label>
                    <input type="text" id="wallet-address" placeholder="0x... or connect MetaMask">
                </div>
                <button class="btn btn-secondary" onclick="connectMetaMask()" style="width: 100%; margin-top: 10px;">
                    ü¶ä Connect MetaMask Wallet
                </button>
            </div>

            <div id="payment-status"></div>

            <button class="btn btn-primary" id="purchase-btn" onclick="initiatePurchase()" 
                    style="width: 100%; margin-top: 20px; font-size: 1.2em;">
                üíé Purchase MountainShares
            </button>
        </div>

        <div class="feature-grid">
            <div class="feature-card">
                <h3>üè™ Local Marketplace</h3>
                <p>Use MountainShares at participating local businesses</p>
            </div>
            <div class="feature-card">
                <h3>üí∞ Employee Bonuses</h3>
                <p>Employers can reward great work with MountainShares</p>
            </div>
            <div class="feature-card">
                <h3>üåü Community Rewards</h3>
                <p>Earn extra MountainShares for community participation</p>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const MOUNTAINSHARES_API = 'https://api.mountainshares.com';
        const CORS_PROXY = 'https://cors-anywhere.herokuapp.com/';
        const FALLBACK_PRICE = 1.00;
        const PROCESSING_FEE_RATE = 0.035;
        
        let useProxyMode = false;
        let currentPricing = null;
        let confirmationModal = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            updatePricing();
            monitorNetworkStatus();
            handleUrlParameters();
            
            // Auto-update pricing when quantity changes
            document.getElementById('ms-quantity').addEventListener('input', updatePricing);
        });

        // Handle URL parameters for payment returns
        function handleUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session_id');
            const success = urlParams.get('success');
            const canceled = urlParams.get('canceled');
            
            if (success === 'true' && sessionId) {
                handlePaymentSuccess(sessionId);
            } else if (canceled === 'true') {
                handlePaymentCanceled();
            }
        }

        // Network status monitoring
        function monitorNetworkStatus() {
            const statusElement = document.getElementById('network-status');
            
            function updateStatus() {
                if (navigator.onLine) {
                    statusElement.textContent = 'üåê Online';
                    statusElement.className = 'network-status network-online';
                } else {
                    statusElement.textContent = '‚ö†Ô∏è Offline';
                    statusElement.className = 'network-status network-offline';
                }
            }
            
            window.addEventListener('online', updateStatus);
            window.addEventListener('offline', updateStatus);
            updateStatus();
        }

        // Pricing functions
        async function updatePricing() {
            const quantity = parseInt(document.getElementById('ms-quantity').value) || 1;
            
            try {
                const pricing = await getPricing(quantity);
                displayPricing(pricing);
                currentPricing = pricing;
            } catch (error) {
                console.error('Pricing update failed:', error);
                const fallbackPricing = calculateFallbackPricing(quantity);
                displayPricing(fallbackPricing);
                currentPricing = fallbackPricing;
            }
        }

        async function getPricing(quantity) {
            const apiUrl = useProxyMode ? 
                `${CORS_PROXY}${MOUNTAINSHARES_API}/calculate-purchase` : 
                `${MOUNTAINSHARES_API}/calculate-purchase`;
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ quantity: quantity })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    return {
                        quantity: data.quantity,
                        pricePerToken: data.pricePerToken,
                        subtotal: data.subtotal,
                        processingFee: data.processingFee,
                        totalCharge: data.totalCharge,
                        live: true
                    };
                } else {
                    throw new Error(data.error || 'API returned error');
                }
            } catch (error) {
                if (!useProxyMode) {
                    useProxyMode = true;
                    return getPricing(quantity);
                }
                throw error;
            }
        }

        function calculateFallbackPricing(quantity) {
            const subtotal = quantity * FALLBACK_PRICE;
            const processingFee = subtotal * PROCESSING_FEE_RATE;
            const totalCharge = subtotal + processingFee;
            
            return {
                quantity: quantity,
                pricePerToken: FALLBACK_PRICE,
                subtotal: subtotal,
                processingFee: processingFee,
                totalCharge: totalCharge,
                live: false
            };
        }

        function displayPricing(pricing) {
            document.getElementById('ms-price').textContent = 
                `$${pricing.pricePerToken.toFixed(2)} each ${pricing.live ? 'üü¢' : 'üî¥'}`;
            document.getElementById('processing-fee').textContent = 
                `$${pricing.processingFee.toFixed(2)}`;
            document.getElementById('total-price').textContent = 
                `$${pricing.totalCharge.toFixed(2)}`;
        }

        // MetaMask integration
        async function connectMetaMask() {
            if (typeof window.ethereum === 'undefined') {
                showStatus('‚ö†Ô∏è MetaMask not found. Please install MetaMask browser extension.', 'error', 'payment-status');
                return;
            }
            
            try {
                showStatus('ü¶ä Connecting to MetaMask...', 'success', 'payment-status');
                
                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts' 
                });
                
                if (accounts.length > 0) {
                    document.getElementById('wallet-address').value = accounts[0];
                    showStatus(`‚úÖ MetaMask connected: ${accounts[0].substring(0, 10)}...${accounts[0].substring(accounts[0].length - 8)}`, 'success', 'payment-status');
                } else {
                    showStatus('‚ö†Ô∏è No MetaMask accounts found. Please unlock MetaMask.', 'warning', 'payment-status');
                }
            } catch (error) {
                console.error('MetaMask connection failed:', error);
                if (error.code === 4001) {
                    showStatus('‚ö†Ô∏è MetaMask connection cancelled by user.', 'warning', 'payment-status');
                } else {
                    showStatus(`‚ùå MetaMask connection failed: ${error.message}`, 'error', 'payment-status');
                }
            }
        }

        // Purchase flow
        async function initiatePurchase() {
            const quantity = parseInt(document.getElementById('ms-quantity').value);
            const walletAddress = document.getElementById('wallet-address').value.trim();
            
            // Validation
            if (!quantity || quantity < 1) {
                showStatus('‚ö†Ô∏è Please enter a valid quantity (minimum 1 MountainShare)', 'error', 'payment-status');
                return;
            }
            
            if (!walletAddress || !walletAddress.startsWith('0x') || walletAddress.length !== 42) {
                showStatus('‚ö†Ô∏è Please enter a valid Ethereum wallet address or connect MetaMask', 'error', 'payment-status');
                return;
            }
            
            // Show confirmation modal
            showPurchaseConfirmation(quantity, currentPricing.totalCharge, walletAddress);
        }

        function showPurchaseConfirmation(quantity, totalPrice, walletAddress) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3 style="color: var(--wv-gold); margin-bottom: 20px;">Confirm Purchase</h3>
                    <p style="color: var(--mountain-white); margin-bottom: 15px; text-align: left;">
                        <strong>Quantity:</strong> ${quantity} MountainShare${quantity > 1 ? 's' : ''}<br>
                        <strong>Total Price:</strong> $${totalPrice.toFixed(2)}<br>
                        <strong>Wallet:</strong> ${walletAddress.substring(0, 10)}...${walletAddress.substring(walletAddress.length - 8)}<br>
                        <strong>Payment Method:</strong> Credit/Debit Card via Stripe
                    </p>
                    <p style="color: #ccc; font-size: 14px; margin-bottom: 20px;">
                        You will be redirected to Stripe's secure checkout page to complete your payment.
                    </p>
                    <div class="modal-buttons">
                        <button class="btn btn-primary" onclick="confirmPurchase()" style="flex: 1;">
                            ‚úÖ Confirm Purchase
                        </button>
                        <button class="btn btn-secondary" onclick="cancelPurchase()" style="flex: 1;">
                            ‚ùå Cancel
                        </button>
                    </div>
                </div>
            `;
            
            confirmationModal = modal;
            document.body.appendChild(modal);
        }

        async function confirmPurchase() {
            if (confirmationModal) {
                document.body.removeChild(confirmationModal);
                confirmationModal = null;
            }
            
            const quantity = parseInt(document.getElementById('ms-quantity').value);
            const walletAddress = document.getElementById('wallet-address').value.trim();
            
            try {
                showStatus('üîÑ Creating payment session...', 'success', 'payment-status');
                document.getElementById('purchase-btn').disabled = true;
                document.getElementById('purchase-btn').innerHTML = '<span class="loading-spinner"></span> Processing...';
                
                const pricing = currentPricing || await getPricing(quantity);
                const amountInCents = Math.round(pricing.totalCharge * 100);
                
                const apiUrl = useProxyMode ? 
                    `${CORS_PROXY}${MOUNTAINSHARES_API}/create-payment-session` : 
                    `${MOUNTAINSHARES_API}/create-payment-session`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        quantity: quantity,
                        walletAddress: walletAddress,
                        amount: amountInCents,
                        productName: `${quantity} MountainShare${quantity > 1 ? 's' : ''}`,
                        customerEmail: null,
                        successUrl: `${window.location.origin}${window.location.pathname}?success=true&session_id={CHECKOUT_SESSION_ID}`,
                        cancelUrl: `${window.location.origin}${window.location.pathname}?canceled=true`
                    })
                });
                
                const session = await response.json();
                
                if (session.success && session.checkoutUrl) {
                    showStatus('‚úÖ Payment session created! Redirecting to checkout...', 'success', 'payment-status');
                    
                    // Add small delay for user feedback
                    setTimeout(() => {
                        window.location.href = session.checkoutUrl;
                    }, 1000);
                    
                } else {
                    throw new Error(session.error || 'Failed to create payment session');
                }
                
            } catch (error) {
                console.error('Purchase failed:', error);
                handlePurchaseError(error);
            } finally {
                document.getElementById('purchase-btn').disabled = false;
                document.getElementById('purchase-btn').textContent = 'üíé Purchase MountainShares';
            }
        }

        function cancelPurchase() {
            if (confirmationModal) {
                document.body.removeChild(confirmationModal);
                confirmationModal = null;
            }
            showStatus('‚ö†Ô∏è Purchase cancelled.', 'warning', 'payment-status');
        }

        // Payment result handlers
        async function handlePaymentSuccess(sessionId) {
            showStatus('üéâ Payment successful! Processing your MountainShares...', 'success', 'payment-status');
            
            try {
                const response = await fetch(`${MOUNTAINSHARES_API}/verify-payment/${sessionId}`);
                const result = await response.json();
                
                if (result.success) {
                    showStatus('', 'success', 'payment-status');
                    displayTransactionDetails(result);
                } else {
                    showStatus('‚ö†Ô∏è Payment received but token delivery pending. Check your email for updates.', 'success', 'payment-status');
                }
            } catch (error) {
                console.error('Payment verification failed:', error);
                showStatus('‚úÖ Payment successful! Your MountainShares will be delivered shortly.', 'success', 'payment-status');
            }
        }

        function handlePaymentCanceled() {
            showStatus('‚ö†Ô∏è Payment was canceled. You can try again anytime.', 'warning', 'payment-status');
        }

        function displayTransactionDetails(transaction) {
            const detailsHtml = `
                <div class="transaction-details">
                    <h4 style="color: #44ff44; margin-bottom: 15px;">üéâ Transaction Complete!</h4>
                    <p style="margin-bottom: 10px;"><strong>Quantity:</strong> ${transaction.quantity} MountainShare${transaction.quantity > 1 ? 's' : ''}</p>
                    <p style="margin-bottom: 10px;"><strong>Wallet:</strong> ${transaction.walletAddress.substring(0, 10)}...${transaction.walletAddress.substring(transaction.walletAddress.length - 8)}</p>
                    <p style="margin-bottom: 10px;"><strong>Transaction ID:</strong> ${transaction.transactionId}</p>
                    ${transaction.blockNumber ? `<p style="margin-bottom: 10px;"><strong>Block Number:</strong> ${transaction.blockNumber}</p>` : ''}
                    <p style="margin-top: 15px; font-size: 14px; color: #ccc;">
                        Your MountainShares have been sent to your wallet. It may take a few minutes to appear in MetaMask.
                    </p>
                    ${transaction.explorerUrl ? `<p style="margin-top: 10px;"><a href="${transaction.explorerUrl}" target="_blank" style="color: #44ff44;">View on blockchain explorer ‚Üí</a></p>` : ''}
                </div>
            `;
            
            document.getElementById('payment-status').innerHTML = detailsHtml;
        }

        // Error handling
        function handlePurchaseError(error) {
            let errorMessage = '‚ùå Purchase failed: ';
            
            if (error.message.includes('insufficient funds')) {
                errorMessage += 'Insufficient funds in your payment method.';
            } else if (error.message.includes('network') || error.message.includes('Failed to fetch')) {
                errorMessage += 'Network error. Please check your connection and try again.';
            } else if (error.message.includes('wallet')) {
                errorMessage += 'Wallet connection error. Please reconnect MetaMask.';
            } else if (error.message.includes('session')) {
                errorMessage += 'Unable to create payment session. Please try again.';
            } else {
                errorMessage += error.message;
            }
            
            showStatus(errorMessage, 'error', 'payment-status');
        }

        // Utility functions
        function showStatus(message, type, elementId) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            element.innerHTML = message ? 
                `<div class="status-message status-${type}">${message}</div>` : '';
        }

        // Auto-retry for failed network requests
        async function retryRequest(requestFunc, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await requestFunc();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
                }
            }
        }
    </script>
</body>
</html>
