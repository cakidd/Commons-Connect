<!DOCTYPE html>
<html>
<head>
    <title>The Commons Connect Feed</title>
    <style>
        .feed-container { max-width: 800px; margin: 0 auto; padding: 20px; font-family: Arial, sans-serif; }
        .feed-item { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);}
        .feed-item img { max-width: 100%; height: auto; border-radius: 4px; margin-top: 10px;}
        .feed-author { font-weight: bold; color: #2c4f90;}
        .feed-timestamp { color: #666; font-size: 0.9em;}
    </style>
</head>
<body>
    <div class="feed-container" id="feed"></div>
    <script>
        // Main feature layer (replace with your layer if different)
        const featureLayerUrl = "https://services7.arcgis.com/glzyAmcOgJqIUWmg/arcgis/rest/services/survey123_5cac06e4e94b43bfbdb2503852578fbf_results/FeatureServer/0";
        // Related tables for photos (indices based on your schema)
        const relatedTables = [
            { index: 1, field: "yard_sale_photos" },
            { index: 2, field: "classified_photos" },
            { index: 3, field: "business_photos2" },
            { index: 4, field: "business_photos" }
        ];

        // Try to fetch the first photo from all related tables for a given objectId
        async function getFirstPhotoUrl(objectId) {
            for (let tbl of relatedTables) {
                try {
                    const url = featureLayerUrl.replace(/\/0$/, `/${tbl.index}`);
                    const resp = await fetch(`${url}/query?where=ParentObjectID=${objectId}&outFields=ATTACHMENTID&returnAttachments=true&f=json`);
                    const data = await resp.json();
                    // Check for attachments in the related table
                    if (data.features && data.features.length > 0 && data.features[0].attachments && data.features[0].attachments.length > 0) {
                        // Build the attachment URL
                        const attachId = data.features[0].attachments[0].id;
                        return `${url}/${data.features[0].attributes.OBJECTID}/attachments/${attachId}`;
                    }
                } catch (e) { /* ignore and try next table */ }
            }
            return null;
        }

        async function loadFeed() {
            try {
                // Select key fields from your schema for the feed
                const outFields = [
                    "header", "created", "yard_sale_notes", "item_name", "classified_description", "name",
                    "address", "city", "zip", "county", "contact_name", "phone", "email"
                ].join(",");
                const response = await fetch(`${featureLayerUrl}/query?where=1=1&outFields=${outFields}&orderByFields=created DESC&f=json`);
                const data = await response.json();
                const feed = document.getElementById("feed");
                feed.innerHTML = "";

                for (const feature of data.features) {
                    const a = feature.attributes;
                    const feedItem = document.createElement("div");
                    feedItem.className = "feed-item";

                    // Fetch the first photo from any related table
                    const imageUrl = await getFirstPhotoUrl(a.OBJECTID);

                    feedItem.innerHTML = `
                        <div class="feed-author">${a.header || a.name || "Anonymous"}</div>
                        <div class="feed-timestamp">${a.created ? new Date(a.created).toLocaleString() : ""}</div>
                        ${a.item_name ? `<div><strong>Item:</strong> ${a.item_name}</div>` : ""}
                        ${a.classified_description ? `<div><strong>Description:</strong> ${a.classified_description}</div>` : ""}
                        ${a.yard_sale_notes ? `<div><strong>Notes:</strong> ${a.yard_sale_notes}</div>` : ""}
                        ${a.address ? `<div><strong>Address:</strong> ${a.address}, ${a.city || ""} ${a.zip || ""} ${a.county || ""}</div>` : ""}
                        ${a.contact_name ? `<div><strong>Contact:</strong> ${a.contact_name} ${a.phone ? "| " + a.phone : ""} ${a.email ? "| " + a.email : ""}</div>` : ""}
                        ${imageUrl ? `<img src="${imageUrl}" alt="Submission photo">` : ""}
                    `;
                    feed.appendChild(feedItem);
                }
            } catch (error) {
                document.getElementById("feed").innerHTML = "⚠️ Failed to load data. Check the console.";
            }
        }

        loadFeed();
    </script>
</body>
</html>
